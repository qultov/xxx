<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#121214">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü">
<title>–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü v11.9</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/svg+xml" href="./icon.svg">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
:root {
    --bg-body: #0d0d10; --bg-surface: #1c1c21; --bg-surface-2: #25252b; --bg-input: #151518;
    --primary: #3b82f6; --primary-gradient: linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);
    --primary-dim: rgba(59,130,246,0.15);
    --accent: #10b981; --accent-gradient: linear-gradient(135deg,#10b981 0%,#059669 100%);
    --danger: #ef4444; --warning: #f59e0b; --whatsapp: #22c55e; --transit: #8b5cf6;
    --text-main: #f3f4f6; --text-sec: #9ca3af; --text-muted: #6b7280;
    --border-light: rgba(255,255,255,0.08); --border-focus: rgba(59,130,246,0.5);
    --spacing-sm: 8px; --spacing-md: 16px;
    --radius-xl: 20px; --radius-lg: 16px; --radius-md: 12px;
    --nav-height: 70px; --header-height: 60px; --visual-gap: 20px;
    --input-height: 52px; --btn-height: 54px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3); --shadow-card: 0 4px 20px rgba(0,0,0,0.25);
    --shadow-glow: 0 0 15px rgba(59,130,246,0.2);
    --backdrop: blur(25px) saturate(180%); --glass-bg: rgba(28,28,33,0.70);
    --anim-speed: 0.25s cubic-bezier(0.25,0.8,0.25,1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text","Inter","Segoe UI",Roboto,sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; font-size: 16px; line-height: 1.5; overflow: hidden; position: fixed; width: 100%; height: 100%; -webkit-font-smoothing: antialiased; }
.noselect { user-select: none; -webkit-user-select: none; }
body.modal-open { overflow: hidden; height: 100vh; }
.container { padding: 0 var(--spacing-md); max-width: 600px; margin: 0 auto; width: 100%; }
.hidden { display: none!important; }

/* LAYOUT */
header, .bottom-nav { position: fixed; left: 0; width: 100%; background: var(--glass-bg); backdrop-filter: var(--backdrop); -webkit-backdrop-filter: var(--backdrop); touch-action: none; z-index: 2000; }
header { top: 0; height: var(--header-height); border-bottom: 1px solid var(--border-light); display: flex; align-items: center; padding: 0 var(--spacing-md); box-shadow: var(--shadow-sm); }
.header-content { width: 100%; max-width: 600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
.app-logo { font-size: 18px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: var(--spacing-sm); letter-spacing: -0.02em; }
.version-badge { font-size: 10px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 6px; color: var(--text-sec); font-weight: 600; }

.tabs-container { position: relative; width: 100%; height: 100%; background: var(--bg-body); overflow: hidden; }
.swipe-track { display: flex; width: 100%; height: 100%; overflow-x: scroll; overflow-y: hidden; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; }
.swipe-track::-webkit-scrollbar { display: none!important; }
.tab-pane { flex: 0 0 100%; width: 100%; min-width: 100%; height: 100%; scroll-snap-align: start; scroll-snap-stop: always; overflow-y: auto; padding-top: calc(var(--header-height) + var(--visual-gap)); padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom) + var(--visual-gap)); }
.container > *:last-child, .cards-list > *:last-child { margin-bottom: 0 !important; }
.container > *:first-child { margin-top: 0 !important; }
.cards-list { margin-bottom: 0 !important; display: flex; flex-direction: column; gap: 12px; }

/* NAV */
.bottom-nav { bottom: 0; height: calc(var(--nav-height) + env(safe-area-inset-bottom)); border-top: 1px solid var(--border-light); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0,0,0,0.3); transition: transform .3s cubic-bezier(0.2,0,0,1); will-change: transform; }
body.keyboard-open .bottom-nav { transform: translateY(110%); pointer-events: none; }
body.keyboard-open .edit-banner { opacity: 0; pointer-events: none; }
.nav-item { background: 0 0; border: none; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 5px; color: var(--text-sec); cursor: pointer; flex: 1; padding: 0; }
.nav-icon { width: 24px; height: 24px; will-change: transform; }
.nav-label { font-size: 10px; font-weight: 500; letter-spacing: .2px; }
.nav-item.active { color: var(--primary); }
.nav-item.active .nav-icon { transform: scale(1.1); }
.nav-pill { position: absolute; top: -1px; left: 0; width: 20%; height: 3px; background: var(--primary); box-shadow: 0 2px 10px var(--primary); border-radius: 0 0 4px 4px; z-index: 2001; pointer-events: none; will-change: transform; }
.icon-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
.nav-badge { position: absolute; top: -4px; right: -8px; background-color: var(--danger); color: #fff; font-size: 9px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid var(--bg-surface); z-index: 10; animation: popIn .3s cubic-bezier(0.175,0.885,0.32,1.275); }

/* FORMS */
label { display: flex; align-items: center; margin: 0 0 8px 4px; color: var(--text-sec); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; }
.icon-label { font-style: normal; margin-right: 6px; font-size: 13px; opacity: .9; }
input, select, textarea, .custom-select-btn { width: 100%; height: var(--input-height); background: var(--bg-input); border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 0 var(--spacing-md); color: var(--text-main); font-size: 16px; transition: all var(--anim-speed); margin-bottom: var(--spacing-md); display: block; font-family: inherit; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #1a1a20; box-shadow: var(--shadow-glow); }
textarea { height: auto; padding: 14px; resize: none; min-height: 80px; }
.input-code { font-family: "Menlo", monospace; font-size: 13px; color: #d1d5db; background: #111; }
.input-sm { height: 42px; font-size: 14px; margin-bottom: 12px; }
.custom-select-btn { text-align: left; display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 0; background-image: none; }
.custom-select-btn::after { content: ''; border: 5px solid transparent; border-top-color: var(--text-sec); margin-top: 3px; }

/* TOGGLES */
.toggles-container { display: flex; gap: 12px; margin-bottom: var(--spacing-md); }
.toggle-btn { flex: 1; height: 50px; border: 1px solid var(--border-light); background: var(--bg-surface); color: var(--text-sec); font-size: 13px; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden; }
.toggle-btn:active { transform: scale(0.97); }
.toggle-btn.active-diff { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: var(--warning); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15); }
.toggle-btn.active-transit { background: rgba(139, 92, 246, 0.15); color: var(--transit); border-color: var(--transit); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15); }

.toggle-row { display: flex; align-items: center; margin-bottom: var(--spacing-md); cursor: pointer; user-select: none; background: var(--bg-surface); border: 1px solid var(--border-light); padding: 14px; border-radius: var(--radius-md); transition: background .2s; }
.toggle-row:active { background: var(--bg-surface-2); }
.toggle-row input { display: none; }
.toggle-visual { position: relative; width: 44px; height: 24px; background: #333; border-radius: 12px; margin-right: 12px; transition: all .3s ease; flex-shrink: 0; }
.toggle-visual::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: all .3s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.toggle-row input:checked+.toggle-visual { background: var(--primary); }
.toggle-row input:checked+.toggle-visual::after { transform: translateX(20px); }
.toggle-text { font-size: 15px; font-weight: 500; color: var(--text-main); }

/* BUTTONS */
button { user-select: none; -webkit-user-select: none; }
.btn-common { width: 100%; border: none; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform .1s,box-shadow .2s; height: var(--btn-height); font-size: 16px; font-weight: 600; color: #fff; }
.btn-common:active { transform: scale(0.97); opacity: .9; }
.btn-main { background: var(--primary-gradient); letter-spacing: .3px; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
.btn-finish { background: var(--accent-gradient); font-weight: 700; box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
.btn-save { background: #292932; color: #666; font-weight: 700; transition: all .3s; cursor: not-allowed; }
.btn-save.dirty { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(59,130,246,0.4); cursor: pointer; }
.btn-whatsapp { background: #25D366; height: 48px; font-size: 15px; font-weight: 700; margin-top: 10px; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); gap: 10px; }
.btn-whatsapp svg { width: 20px; height: 20px; fill: currentColor; display: block; }
.btn-sec { width: 100%; height: 44px; background: 0 0; color: var(--text-sec); border: none; font-weight: 500; cursor: pointer; font-size: 14px; }
.btn-dashed { border: 1px dashed var(--text-muted); border-radius: var(--radius-md); color: var(--primary); width: 100%; height: 44px; background: rgba(59,130,246,0.05); font-weight: 600; font-size: 14px; margin-bottom: 20px; cursor: pointer; transition: background .2s; }
.btn-dashed:active { background: rgba(59,130,246,0.1); }
.btn-icon-small { background: rgba(255,255,255,0.05); border: 1px solid var(--border-light); width: 36px; height: 36px; border-radius: 50%; color: var(--text-sec); font-size: 16px; display: flex; align-items: center; justify-content: center; }
.btn-quick-add { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 20px; display: none; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
.btn-remove { width: var(--input-height); height: var(--input-height); background: rgba(239,68,68,0.1); color: var(--danger); border: none; border-radius: var(--radius-md); font-size: 18px; flex-shrink: 0; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 !important; line-height: 1 !important; }
.btn-help-mini { background: rgba(255,255,255,0.08); width: 24px; height: 24px; border-radius: 50%; border: none; color: var(--text-sec); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.btn-copy { background: var(--primary-dim); color: var(--primary); border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; }
.btn-reset { width: 100%; background: 0 0; border: 1px solid var(--border-light); color: var(--text-sec); height: 44px; border-radius: var(--radius-md); font-size: 13px; cursor: pointer; }
.btn-install-app { display: none; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; width: 100%; margin-bottom: 20px; height: 60px; font-size: 16px; font-weight: 700; border-radius: var(--radius-lg); border: none; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

/* CARDS & TAGS */
.card-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.u-tag { display: inline-flex; align-items: center; justify-content: center; height: 28px; padding: 0 10px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid transparent; white-space: nowrap; box-sizing: border-box; }
.u-tag.tag-route { background: #333; color: #ddd; border-color: rgba(255,255,255,0.1); }
.u-tag.tag-transit { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border-color: rgba(139, 92, 246, 0.2); }
.u-tag.tag-address { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }
.u-tag.tag-amount { font-family: "Menlo", monospace; background: transparent; color: var(--accent); border: none; letter-spacing: -0.5px; font-size: 14px; font-weight: 700; padding: 0; height: auto; margin: 0; }
.u-tag.tag-amount.empty { font-size: 14px; font-weight: 600; color: var(--text-muted); background: transparent; border: 1px solid var(--border-light); padding: 2px 6px; height: 24px; border-radius: 6px; }

.card, .input-card, .report-card, .settings-group { background: var(--bg-surface); border: 1px solid var(--border-light); }
.input-card, .settings-group { border-radius: var(--radius-xl); padding: 20px; box-shadow: var(--shadow-card); margin-bottom: 24px; }
.input-card { margin-bottom: 0; }
.card { border-radius: var(--radius-lg); padding: 16px; position: relative; display: flex; flex-direction: column; gap: 8px; user-select: none; -webkit-user-select: none; transition: transform .1s,background .2s, box-shadow .2s, opacity .2s; cursor: pointer; box-shadow: var(--shadow-sm); touch-action: pan-x pan-y; }
.card:active { transform: scale(0.98); background-color: var(--bg-surface-2); }
.card.editing-focus { box-shadow: 0 0 0 2px var(--primary); border-color: var(--primary); }
.card.is-dragging-placeholder { opacity: 0.3; background: var(--bg-surface-2); box-shadow: inset 0 0 0 2px var(--primary-dim); }
.card-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.card-azs { font-size: 17px; font-weight: 700; color: #fff; line-height: 1.3; }
.card-note { font-size: 13px; color: var(--text-sec); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
.empty-state { text-align: center; color: var(--text-muted); padding: 60px 0; font-size: 15px; font-weight: 500; }
.empty-list-stub { text-align:center; color:#555; font-size:13px; padding:10px; }

/* ARCHIVE */
.ac-card { background: var(--bg-surface); border-radius: var(--radius-lg); margin-bottom: 12px; border: 1px solid var(--border-light); overflow: hidden; }
.ac-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); cursor: pointer; transition: background .2s; user-select: none; -webkit-user-select: none; }
.ac-header:active { background: rgba(255,255,255,0.05); }
.ac-date { font-weight: 600; color: var(--text-main); font-size: 15px; display: flex; align-items: center; gap: 8px; }
.ac-body { display: none; padding: 0; border-top: 1px solid var(--border-light); }
.ac-body.open { display: block; animation: slideDown .2s; }
.ac-body .card { background: 0 0; border: none; border-bottom: 1px solid var(--border-light); border-radius: 0; margin: 0; padding: 14px 16px; box-shadow: none; }
.ac-body .card:last-child { border-bottom: none; }
.badge-counter { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; min-width: 24px; text-align: center; }

/* CHIPS & AUTOCOMPLETE */
.chips-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; max-height: 140px; overflow-y: auto; padding-bottom: 5px; }
.chip { background: var(--bg-surface-2); color: var(--text-sec); padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid var(--border-light); transition: all .2s; white-space: nowrap; flex-shrink: 0; }
.chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
.chip.taken { background: rgba(245,158,11,0.15); color: var(--warning); border-color: rgba(245,158,11,0.3); }
.wrapper-relative { position: relative; width: 100%; margin-bottom: 16px; }
.wrapper-with-btn input { padding-right: 50px!important; }
.autocomplete-wrapper { position: relative; z-index: 50; }
.autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: #222226; border-radius: var(--radius-md); z-index: 1000; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.8); margin-top: 6px; border: 1px solid var(--border-light); display: none; }
.autocomplete-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); font-size: 15px; }
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:active { background: var(--primary); color: #fff; }

/* HELPERS */
.label-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.amounts-container { margin-bottom: 12px; }
.amount-row { display: flex; gap: 10px; margin-bottom: 10px; }
.amount-row input { margin-bottom: 0; font-family: monospace; font-size: 18px; letter-spacing: -.5px; }
.contact-row { display: flex; align-items: center; background: var(--bg-surface); padding: 10px 14px; border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--border-light); }
.contact-info { flex: 1; }
.contact-name { font-weight: 600; color: #fff; font-size: 14px; }
.contact-phone { font-family: monospace; font-size: 12px; color: var(--text-sec); margin-top: 2px; }

/* SETTINGS MENU */
.menu-btn-row { display: flex; align-items: center; justify-content: space-between; background: var(--bg-surface-2); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; border: 1px solid var(--border-light); cursor: pointer; transition: all .2s; }
.menu-btn-row:active { background: #333; transform: scale(0.99); }
.mbr-icon { font-size: 20px; margin-right: 12px; display: inline-block; width: 30px; text-align: center; }
.mbr-title { flex: 1; font-weight: 600; font-size: 15px; color: #fff; }
.mbr-badge { background: #333; color: var(--text-sec); font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-right: 8px; }
.mbr-arrow { color: var(--text-muted); font-size: 14px; font-weight: 700; }
.settings-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
.settings-grid-container .menu-btn-row { position: relative; flex-direction: column; align-items: center; justify-content: center; text-align: center; margin-bottom: 0; height: 110px; padding: 15px; }
.settings-grid-container .mbr-icon { font-size: 32px; margin-bottom: 10px; margin-right: 0; width: auto; }
.settings-grid-container .mbr-title { font-size: 13px; line-height: 1.3; width: 100%; }
.settings-grid-container .mbr-badge { position: absolute; top: 10px; right: 10px; margin: 0; font-size: 11px; align-self: auto; }
.settings-grid-container .mbr-arrow { display: none; }

/* FULL SCREEN MANAGER */
.full-screen-manager { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 2500; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); visibility: hidden; }
.full-screen-manager.active { transform: translateX(0); visibility: visible; }
.fsm-header { height: var(--header-height); display: flex; justify-content: space-between; align-items: center; padding: 0 var(--spacing-md); background: var(--glass-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-light); flex-shrink: 0; }
.fsm-header > div, .fsm-header > button { flex-shrink: 0; }
.fsm-back-btn { background: none; border: none; color: var(--primary); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 0; min-width: 60px; }
.fsm-title { font-size: 17px; font-weight: 700; color: #fff; text-align: center; }
.fsm-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
.sticky-search { position: sticky; top: 0; z-index: 10; background: rgba(13, 13, 16, 0.9); backdrop-filter: blur(12px); padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid transparent; }
.segmented-control { display: flex; background: rgba(118, 118, 128, 0.24); border-radius: 8px; padding: 2px; width: auto; min-width: 170px; max-width: 220px; margin: 0 10px; flex: 1; }
.sc-btn { flex: 1; border: none; background: transparent; color: var(--text-sec); font-size: 13px; font-weight: 500; padding: 6px 0; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.sc-btn.active { background: #636366; color: #fff; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

/* MANAGER CARDS */
.manager-card { display: flex; align-items: center; justify-content: space-between; background: var(--bg-surface); border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all .2s; }
.manager-card:active { transform: scale(0.98); border-color: var(--primary); background: var(--bg-surface-2); }
.rm-info { flex: 1; min-width: 0; }
.rm-title { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.rm-badge { background: var(--primary-dim); color: var(--primary); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; letter-spacing: 0.5px; }
.rm-hint { font-size: 12px; color: var(--text-sec); line-height: 1.4; white-space: normal; overflow-wrap: break-word; }
.rm-icon { font-size: 18px; color: var(--text-muted); margin-left: 12px; }
.azs-title { font-size: 15px; font-weight: 500; color: #eee; }

.section-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
.section-title { font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -.5px; }
.divider { height: 1px; background: var(--border-light); margin: 20px 0; }
.flex-row { display: flex; align-items: center; }
.gap-10 { gap: 10px; } .flex-1 { flex: 1; }
.mt-10 { margin-top: 10px; } .mt-20 { margin-top: 20px; } .mt-30 { margin-top: 30px; } .mt-40 { margin-top: 40px; }
.mb-10 { margin-bottom: 10px; } .mb-15 { margin-bottom: 15px; }
.p-0 { padding: 0!important; } .m-0 { margin: 0!important; }
.max-w-90 { max-width: 90%; } .text-left { text-align: left; }
.bg-transparent { background: 0 0!important; } .text-danger { color: var(--danger)!important; } .text-primary { color: var(--primary); }
.hidden-fields { display: none; background: rgba(0,0,0,0.2); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px; border-left: 3px solid var(--warning); }
.hidden-fields.active { display: block; animation: slideDown .2s forwards; position: relative; z-index: 100; }
.route-hint-text { font-size: 13px; color: var(--warning); margin-bottom: 15px; padding-left: 5px; min-height: 20px; margin-top: 10px; line-height: 1.4; }
.settings-header { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 16px; opacity: .9; }
#tab-settings input[type=text], #tab-settings textarea { background: #111; border: 1px solid var(--border-light); color: #ddd; font-family: "Menlo", monospace; font-size: 13px; }
.report-card { border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px; }
.report-toolbar { background: var(--bg-surface-2); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); }
.report-label { font-size: 11px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: .5px; }
.report-content { padding: 16px; font-family: "Menlo", monospace; font-size: 12px; color: #ddd; white-space: pre-wrap; line-height: 1.5; }

/* MODALS */
.bs-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 3000; opacity: 0; visibility: hidden; transition: .3s; display: flex; align-items: flex-end; }
.bs-overlay.active { opacity: 1; visibility: visible; }
.bs-panel { width: 100%; background: #18181b; border-radius: 28px 28px 0 0; padding: 24px; padding-bottom: calc(24px + env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform .3s cubic-bezier(0.2,0.9,0.3,1); max-height: 85vh; display: flex; flex-direction: column; border-top: 1px solid var(--border-light); box-shadow: 0 -10px 50px rgba(0,0,0,0.5); position: relative; }
.bs-panel::before { content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; pointer-events: none; }
.bs-overlay.active .bs-panel { transform: translateY(0); }
.bs-header { text-align: center; font-weight: 700; color: #fff; margin-bottom: 24px; font-size: 16px; margin-top: 10px; }
.bs-content { overflow-y: auto; touch-action: pan-y; }
.bs-item { width: 100%; padding: 16px; background: var(--bg-surface-2); border: 1px solid var(--border-light); border-radius: 16px; color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.bs-item:active { transform: scale(0.98); background: #333; }
.bs-item.selected { border-color: var(--primary); background: rgba(59,130,246,0.1); color: var(--primary); }
.bs-action-btn { width: 100%; padding: 18px; background: rgba(255,255,255,0.03); border: none; margin: 0; border-bottom: 1px solid var(--border-light); color: #fff; font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 16px; text-align: left; border-radius: 0; }
.bs-action-btn:first-child { border-radius: 16px 16px 0 0; }
.bs-action-btn:last-child { border-radius: 0 0 16px 16px; border-bottom: none; }
.bs-action-btn:active { background: rgba(255,255,255,0.08); }
.bs-action-btn.danger { color: var(--danger); }
.custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 4000; align-items: center; justify-content: center; }
.custom-modal.active { display: flex; animation: fadeIn .2s; }
.cm-card { background: #222226; width: 85%; max-width: 340px; border-radius: 24px; padding: 28px; text-align: center; border: 1px solid var(--border-light); box-shadow: 0 20px 60px rgba(0,0,0,0.6); transform: scale(0.9); animation: popIn .2s forwards; }
.cm-title { font-size: 19px; font-weight: 700; margin-bottom: 12px; color: #fff; }
.cm-text { font-size: 15px; color: var(--text-sec); margin-bottom: 28px; line-height: 1.5; }
.cm-btns { display: flex; gap: 12px; }
.cm-btn { flex: 1; height: 48px; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; font-size: 15px; }
.cm-confirm { background: var(--primary); color: #fff; }
.cm-danger { background: var(--danger); color: #fff; }
.cm-cancel { background: #333; color: #ccc; }
.edit-banner { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(245,158,11,0.15); border: 1px solid var(--warning); color: var(--warning); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; z-index: 80; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(4px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.cheat-content-scroll { max-height: 50vh; overflow-y: auto; margin-bottom: 15px; }
.cheat-row { display: flex; border-bottom: 1px solid var(--border-light); padding: 10px 0; }
.cheat-route { width: 60px; font-weight: 700; color: var(--warning); margin-right: 12px; flex-shrink: 0; }
.cheat-desc { font-size: 13px; color: #ccc; line-height: 1.4; }
.card-clone { position: fixed; z-index: 10000; pointer-events: none; box-shadow: 0 15px 40px rgba(0,0,0,0.6); transform: scale(1.05) rotate(1deg); opacity: 0.95; border-radius: var(--radius-lg); background: var(--bg-surface); border: 1px solid var(--primary); width: 100%; transform-origin: center center; }
body.dragging-active { overflow: hidden !important; user-select: none; -webkit-user-select: none; touch-action: none; }
.pulse-icon { animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: .5; } 100% { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
#routeEditorSheet, #azsEditorSheet, #noteEditorSheet, #contactEditorSheet { z-index: 3100 !important; }
#bottomSheet { z-index: 3500 !important; }
</style>
</head>
<body>

<header id="appHeader">
<div class="header-content">
<div class="app-logo"><img width="40" height="40" src="./icon.svg" alt="box"/>–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü <span class="version-badge">v11.9</span></div>
<div id="headerActionArea"></div>
</div>
</header>

<div id="editModeBanner" class="edit-banner" style="display:none">
<span class="pulse-icon">‚úèÔ∏è</span> –†–ï–ñ–ò–ú –ü–†–ê–í–ö–ò
</div>

<main class="tabs-container">
<div id="swipeTrack" class="swipe-track">
<section id="tab-input" class="tab-pane active">
<div class="container">
<div class="input-card">
<label><i class="icon-label">‚õΩ</i> –¢–æ—á–∫–∞ / –ê–ó–°</label>
<div class="wrapper-with-btn autocomplete-wrapper wrapper-relative">
<input type="text" id="azsInput" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off">
<button id="quickAddAzsBtn" class="btn-quick-add" onclick="genericQuickAdd(state.refAzs,'azsInput','quickAddAzsBtn','–ê–ó–° –¥–æ–±–∞–≤–ª–µ–Ω–∞')">+</button>
<div id="azsList" class="autocomplete-list"></div>
</div>
<label><i class="icon-label">üí∞</i> –°—É–º–º—ã</label>
<div id="amountsContainer" class="amounts-container"></div>
<button class="btn-dashed" onclick="addAmountField()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—É–º–º—É</button>
<label><i class="icon-label">‚ö°</i> –û–ø—Ü–∏–∏ –∑–∞—è–≤–∫–∏</label>
<div class="toggles-container">
    <button id="btnToggleDiff" class="toggle-btn" onclick="toggleAddressMode()">üìç –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</button>
    <button id="btnToggleTransit" class="toggle-btn" onclick="toggleTransitMode()">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</button>
</div>
<div id="diffAddressBlock" class="hidden-fields">
<label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
<div class="autocomplete-wrapper wrapper-with-btn wrapper-relative">
<input type="text" id="factAddressInput" placeholder="–ö—É–¥–∞ –≤–µ–∑—Ç–∏..." autocomplete="off">
<button id="quickAddFactBtn" class="btn-quick-add" onclick="genericQuickAdd(state.refAzs,'factAddressInput','quickAddFactBtn','–ê–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É')" style="display:none">+</button>
<div id="factAddressList" class="autocomplete-list"></div>
</div>
</div>
<label class="label-header">
<span><i class="icon-label">üöö</i> –ú–∞—Ä—à—Ä—É—Ç</span>
<button class="btn-help-mini" onclick="openRouteCheatSheet()">?</button>
</label>
<div class="route-row">
<div class="route-wrapper">
<select id="routeSelect" style="display:none"></select>
<button id="routeSelectBtn" class="custom-select-btn" onclick="openRouteSheet()">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</button>
</div>
</div>
<div id="routeHint" class="route-hint-text"></div>
<div class="label-header">
<label class="m-0"><i class="icon-label">üìù</i> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
<button class="btn-dashed" style="width:auto;height:32px;font-size:11px;padding:0 12px;margin:0 0 5px 0" onclick="openNoteSheet()">–í—ã–±—Ä–∞—Ç—å...</button>
</div>
<div class="wrapper-with-btn wrapper-relative">
<input type="text" id="noteInput" placeholder="–°–ø—Ä–æ—Å–∏—Ç—å, –û—Ñ–∏—Å..." autocomplete="off">
<button id="quickAddNoteBtn" class="btn-quick-add" onclick="genericQuickAdd(state.refNotes,'noteInput','quickAddNoteBtn')">+</button>
</div>
<div class="form-actions-row mt-20">
<button id="mainActionBtn" class="btn-common btn-main flex-2" onclick="handleMainAction()">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
</div>
<button id="cancelEditBtn" class="btn-sec text-danger mt-10" style="display:none" onclick="resetForm()">–û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
</div>
</div>
</section>

<section id="tab-list" class="tab-pane">
<div class="container">
<div class="section-header-row">
<div class="section-title">–¢–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏</div>
<div class="badge-counter" id="draftCount">0</div>
</div>
<div id="draftList" class="cards-list">
<div class="empty-state">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
</div>
<div class="mt-30">
<button id="archiveBtn" class="btn-common btn-finish" style="display:none" onclick="saveToArchive()"><span>üèÅ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å</button>
</div>
<button id="cancelArchiveEditBtn" class="btn-sec mt-10" style="display:none" onclick="cancelArchiveEdit()">–í—ã–π—Ç–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞</button>
</div>
</section>

<section id="tab-reports" class="tab-pane">
<div class="container">
<div class="report-card">
<div class="report-toolbar">
<div class="report-label">üë§ –î–ª—è –û–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
<button class="btn-copy" onclick="copyReportText($('reportOperator').textContent)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<div class="report-content" id="reportOperator"></div>
<div style="padding:0 16px 16px 16px">
<button class="btn-common btn-whatsapp" onclick="handleSendReport('operator')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É</button>
</div>
</div>
<div class="report-card">
<div class="report-toolbar">
<div class="report-label">üöö –î–ª—è –≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä–∞</div>
<button class="btn-copy" onclick="copyReportText($('reportExpeditor').textContent)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<div class="report-content" id="reportExpeditor"></div>
<div style="padding:0 16px 16px 16px">
<button class="btn-common btn-whatsapp" onclick="handleSendReport('expeditor')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç —ç–∫—Å–ø–µ–¥–∏—Ç–æ—Ä—É</button>
</div>
</div>
</div>
</section>

<section id="tab-archive" class="tab-pane">
<div class="container">
<div class="section-header-row">
<div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–π</div>
<button class="btn-icon-small" onclick="clearAllArchive()">üóë</button>
</div>
<div id="archiveContainer"></div>
</div>
</section>

<section id="tab-settings" class="tab-pane">
<div class="container">
<button id="installAppBtn" class="btn-install-app" onclick="installPWA()">üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω</button>
<div class="settings-header">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–î–∞–Ω–Ω—ã–µ)</div>
<div class="settings-grid-container">
    <div class="menu-btn-row" onclick="openAzsManagerScreen()">
        <span class="mbr-icon">‚õΩ</span><span class="mbr-title">–ë–∞–∑–∞ –ê–ó–°</span><span class="mbr-badge" id="azsCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openRoutesManagerScreen()">
        <span class="mbr-icon">üöö</span><span class="mbr-title">–ú–∞—Ä—à—Ä—É—Ç—ã</span><span class="mbr-badge" id="routesCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openNotesManagerScreen()">
        <span class="mbr-icon">üìù</span><span class="mbr-title">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span><span class="mbr-badge" id="notesCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openContactsManagerScreen()">
        <span class="mbr-icon">üìû</span><span class="mbr-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span><span class="mbr-badge" id="contactsCountBadge">0</span>
    </div>
</div>
<textarea id="settingAzs" class="hidden"></textarea>
<textarea id="settingRoutes" class="hidden"></textarea>
<textarea id="settingNotes" class="hidden"></textarea>

<div class="settings-group">
    <div class="settings-header">–ü—Ä–∞–≤–∏–ª–∞ –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</div>
    <div class="setting-row-toggle mb-15">
        <label class="toggle-row bg-transparent p-0 m-0" style="border:none">
            <input type="checkbox" id="settingAutoSort" onchange="vibrate()">
            <div class="toggle-visual"></div>
            <div class="toggle-text">–ê–≤—Ç–æ-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞—è–≤–æ–∫</div>
        </label>
    </div>
    <div class="menu-btn-row" onclick="openBindingsManagerScreen()">
        <div style="display:flex; align-items:center;">
            <span class="mbr-icon">üîó</span>
            <div style="display:flex; flex-direction:column;"><span class="mbr-title">–ü—Ä–∏–≤—è–∑–∫–∏ –ê–ó–°</span><span style="font-size:11px; color:var(--text-sec); font-weight:400; margin-top:2px;">–ê–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</span></div>
        </div>
        <div style="display:flex; align-items:center;"><span class="mbr-badge" id="bindingsCountBadge">0</span><span class="mbr-arrow">‚Ä∫</span></div>
    </div>
    <div class="menu-btn-row" onclick="openRulesManagerScreen()">
        <div style="display:flex; align-items:center;">
            <span class="mbr-icon">‚áÑ</span>
            <div style="display:flex; flex-direction:column;"><span class="mbr-title">–†–µ–∂–∏–º ¬´–¢—Ä–∞–Ω–∑–∏—Ç¬ª</span><span style="font-size:11px; color:var(--text-sec); font-weight:400; margin-top:2px;">–ê–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∏—Ç–∞</span></div>
        </div>
        <div style="display:flex; align-items:center;"><span class="mbr-badge" id="transitCountBadge">0</span><span class="mbr-arrow">‚Ä∫</span></div>
    </div>
    <textarea id="settingTransitList" rows="2" class="hidden"></textarea>
</div>

<div class="settings-group">
<div class="settings-header">–°–∏—Å—Ç–µ–º–∞</div>
<div class="menu-btn-row" onclick="openDataManagerScreen()">
    <div style="display:flex; align-items:center;"><span class="mbr-icon">üíæ</span><span class="mbr-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span></div>
    <div style="display:flex; align-items:center;"><span class="mbr-arrow">‚Ä∫</span></div>
</div>
<input type="file" id="importFile" style="display:none" accept=".json" onchange="importDb(this)">
</div>
<div class="mt-40 buttons-row">
<button id="saveSettingsBtn" class="btn-save btn-common" style="width:100%" onclick="saveSettings()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button id="cancelSettingsBtn" class="btn-reset mt-10" style="width:100%;height:50px;display:none" onclick="revertSettings()">–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</div>
</div>
</section>
</div>
</main>

<nav class="bottom-nav">
<button class="nav-item active" onclick="switchTab('tab-input',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
<span class="nav-label">–ù–æ–≤–∞—è</span>
</button>
<button class="nav-item" onclick="switchTab('tab-list',this)">
<div class="icon-wrapper">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
<span id="navBadge" class="nav-badge" style="display:none">0</span>
</div>
<span class="nav-label">–°–ø–∏—Å–æ–∫</span>
</button>
<button class="nav-item" onclick="switchTab('tab-reports',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
<span class="nav-label">–û—Ç—á–µ—Ç—ã</span>
</button>
<button class="nav-item" onclick="switchTab('tab-archive',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
<span class="nav-label">–ò—Å—Ç–æ—Ä–∏—è</span>
</button>
<button class="nav-item" onclick="switchTab('tab-settings',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.15 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
<span class="nav-label">–ú–µ–Ω—é</span>
</button>
<div class="nav-pill"></div>
</nav>

<div id="bottomSheet" class="bs-overlay" onclick="closeBottomSheet(event)">
<div id="bsPanel" class="bs-panel"><div id="bsHeader" class="bs-header">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</div><div id="bsContent" class="bs-content"></div></div>
</div>

<div id="customModal" class="custom-modal">
<div class="cm-card"><div id="cmTitle" class="cm-title"></div><div id="cmText" class="cm-text"></div><input type="text" id="cmInput" class="cm-input" style="display:none" autocomplete="off"><div class="cm-btns" id="cmButtons"></div></div>
</div>

<div id="routeCheatModal" class="custom-modal">
<div class="cm-card cheat-card p-20 max-w-90"><div class="cm-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</div><div id="cheatSheetContent" class="cheat-content-scroll text-left"></div><button class="cm-btn cm-confirm btn-left" onclick="closeRouteCheatSheet()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div>

<div id="view-routes-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeRoutesManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ú–∞—Ä—à—Ä—É—Ç—ã</div><div class="header-action"><button class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openRouteEditor()">+</button></div></div>
    <div class="fsm-content"><div id="routesManagerList"></div></div>
</div>

<div id="view-contacts-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeContactsManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div style="width:60px"></div></div>
    <div class="fsm-content">
        <div class="section-header-row mt-10" style="padding:0 4px;"><div class="settings-header m-0">üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã</div><button class="btn-icon-small" style="width:32px; height:32px; border-radius:8px; background:rgba(59,130,246,0.15); color:var(--primary); border:none;" onclick="openContactEditor(null, 'operator')">+</button></div>
        <div id="contactsOperatorList" class="cards-list mb-15"></div>
        <div class="divider"></div>
        <div class="section-header-row" style="padding:0 4px;"><div class="settings-header m-0">üöö –≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä—ã</div><button class="btn-icon-small" style="width:32px; height:32px; border-radius:8px; background:rgba(16,185,129,0.15); color:var(--accent); border:none;" onclick="openContactEditor(null, 'expeditor')">+</button></div>
        <div id="contactsExpeditorList" class="cards-list"></div>
    </div>
</div>

<div id="view-notes-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeNotesManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div><div class="header-action"><button class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openNoteEditor()">+</button></div></div>
    <div class="fsm-content"><div id="notesManagerList" class="mt-10"></div></div>
</div>

<div id="view-azs-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeAzsManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ë–∞–∑–∞ –ê–ó–°</div><div class="header-action"><button id="btnAzsAdd" class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openAzsEditor()">+</button></div></div>
    <div class="fsm-content">
        <div style="padding-bottom: 15px;"><div class="segmented-control" style="width: 100%; max-width: 100%; margin: 0;"><button id="scBtnList" class="sc-btn active" onclick="setAzsMode('list')">–°–ø–∏—Å–æ–∫</button><button id="scBtnText" class="sc-btn" onclick="setAzsMode('text')">–¢–µ–∫—Å—Ç</button></div></div>
        <div id="azsListContainer">
            <div class="sticky-search"><input type="search" id="azsManagerSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ê–ó–°..." class="input-sm" style="margin:0;"></div>
            <div id="azsManagerList" class="mt-10"></div>
        </div>
        <div id="azsMassEditContainer" style="display:none; height:100%; flex-direction:column;"><div class="route-hint-text">–ö–∞–∂–¥–∞—è –ê–ó–° —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏</div><textarea id="azsMassInput" style="flex:1; background:#111; font-family:monospace; padding:10px; resize:none; border-radius:12px; font-size:14px; line-height:1.5;"></textarea></div>
    </div>
</div>

<div id="view-rules-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeRulesManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–¢—Ä–∞–Ω–∑–∏—Ç</div><div style="width:60px"></div></div>
    <div class="fsm-content"><div id="rulesTransitContainer"><div class="route-hint-text">–ê–ó–°, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∑–¥–µ—Å—å, –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—Ç—å —Ä–µ–∂–∏–º "–¢—Ä–∞–Ω–∑–∏—Ç".</div><div class="sticky-search"><input type="text" placeholder="–ü–æ–∏—Å–∫ –ê–ó–°..." class="input-sm" style="margin:0;" oninput="filterChips('rulesTransitWrapper',this.value)"></div><div id="rulesTransitWrapper" class="chips-wrapper" style="max-height: none; justify-content: flex-start; padding-top:10px;"></div></div></div>
</div>

<div id="view-bindings-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeBindingsManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ü—Ä–∏–≤—è–∑–∫–∏</div><div style="width:60px"></div></div>
    <div class="fsm-content"><div class="route-hint-text">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ê–ó–°, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div><div id="bindingsManagerList" class="mt-10"></div></div>
</div>

<div id="view-data-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="closeDataManagerScreen()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div><div style="width:60px"></div></div>
    <div class="fsm-content">
        <div class="settings-header mt-10">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
        <div class="menu-btn-row" onclick="exportDb()"><div style="display:flex; align-items:center;"><span class="mbr-icon">üì•</span><div style="display:flex; flex-direction:column;"><span class="mbr-title">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–∑—É</span><span style="font-size:11px; color:var(--text-sec); font-weight:400; margin-top:2px;">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π</span></div></div></div>
        <div class="menu-btn-row" onclick="$('importFile').click()"><div style="display:flex; align-items:center;"><span class="mbr-icon">üì§</span><div style="display:flex; flex-direction:column;"><span class="mbr-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</span><span style="font-size:11px; color:var(--text-sec); font-weight:400; margin-top:2px;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞</span></div></div></div>
        <div class="divider"></div>
        <div class="settings-header text-danger">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div>
        <div class="menu-btn-row" style="border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);" onclick="fullReset()"><div style="display:flex; align-items:center;"><span class="mbr-icon">üóë</span><div style="display:flex; flex-direction:column;"><span class="mbr-title" style="color:var(--danger)">–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫</span><span style="font-size:11px; color:var(--text-sec); font-weight:400; margin-top:2px;">–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span></div></div></div>
    </div>
</div>

<div id="routeEditorSheet" class="bs-overlay" onclick="closeRouteEditor(event)">
    <div class="bs-panel"><div class="bs-header" id="routeEditorTitle">–ú–∞—Ä—à—Ä—É—Ç</div><div class="bs-content"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</label><input type="text" id="editRouteName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4/4"><label>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (–†–∞–π–æ–Ω—ã)</label><textarea id="editRouteHint" rows="3" placeholder="–†–∞–π–æ–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..."></textarea><div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveRouteFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteRoute" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteRouteFromEditor()">üóë</button></div></div></div>
</div>

<div id="azsEditorSheet" class="bs-overlay" onclick="closeAzsEditor(event)">
    <div class="bs-panel"><div class="bs-header" id="azsEditorTitle">–ê–ó–°</div><div class="bs-content"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –ê–ó–°</label><input type="text" id="editAzsName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Sinooil –°–∞—è—Ö–∞—Ç"><div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveAzsFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteAzs" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteAzsFromEditor()">üóë</button></div></div></div>
</div>

<div id="noteEditorSheet" class="bs-overlay" onclick="closeNoteEditor(event)">
    <div class="bs-panel"><div class="bs-header" id="noteEditorTitle">–ö–Ω–æ–ø–∫–∞</div><div class="bs-content"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</label><input type="text" id="editNoteName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í –û—Ñ–∏—Å"><div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveNoteFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteNote" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteNoteFromEditor()">üóë</button></div></div></div>
</div>

<div id="contactEditorSheet" class="bs-overlay" onclick="closeContactEditor(event)">
    <div class="bs-panel"><div class="bs-header" id="contactEditorTitle">–ö–æ–Ω—Ç–∞–∫—Ç</div><div class="bs-content"><label>–ò–º—è / –ú–µ—Ç–∫–∞</label><input type="text" id="contactNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ñ–∏—Å" autocomplete="off"><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label><input type="tel" id="contactPhoneInput" placeholder="7701..." autocomplete="off"><div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveContactFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteContact" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteContactFromEditor()">üóë</button></div></div></div>
</div>

<input type="datetime-local" id="archiveDatePicker" style="position:absolute;top:-9999px;visibility:hidden;">
<script>
const $=id=>document.getElementById(id);
const $$=sel=>document.querySelectorAll(sel);
const vibrate=(p=10)=>{if(navigator.vibrate)navigator.vibrate(p)};
const RU_MAP={'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z','–∏':'i','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'c','—á':'ch','—à':'sh','—â':'sch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'};
const getSearchCode=str=>{if(!str)return"";let s=str.toLowerCase().split('').map(char=>RU_MAP[char]||char).join('');return s.replace(/x/g,'h').replace(/h/g,'g').replace(/[cq]/g,'k').replace(/ck/g,'k').replace(/[yj]/g,'i').replace(/z/g,'s').replace(/ph/g,'f').replace(/[^a-z0-9]/g,'')};
const DB={get:(key,def=[])=>{try{return JSON.parse(localStorage.getItem(key))||def}catch{return def}},set:(key,val)=>localStorage.setItem(key,JSON.stringify(val))};
const parseList=val=>val.split(',').map(s=>s.trim()).filter(Boolean);
const DEFAULTS={azs:["Sinooil","–ì–µ–ª–∏–æ—Å","Compas","–ú—É–Ω–∞–π","Dala Brand"],routes:["1/1","2/1","4/3","4/4","–°–ó"],notes:["–¢–∞—Å–±—É–≥–µ—Ç","–ö–æ–ª—å—Ü–µ–≤–∞—è","–ö–∞–∑–ì—é–∞","–¶–µ–Ω—Ç—Ä","–í–æ–Ω—é—á–∫–∞","–ö–ë–ò"]};
const DEFAULT_HINTS={"1/1":"–¶–ï–ù–¢–†, –ñ–ê–ô–ù–ê, –ú–ï–†–ï–ô, –ê–ö–ú–ï–ß–ï–¢–¨, –ó–£–ë–ï–ù–ö–ê, –ü–ï–†–û–ù","2/1":"–ê–†–ê–ô, –®“∞–ì–´–õ–ê, 1000 –ú–ï–õ–û–ß–ï–ô, –£–ù–ò–í–ï–†–°–ê–ú, –î–≠–£, –ù–ê–ë–ï–†–ï–ñ–ù–ê–Ø, –û–ú–¶, –ù–ê–õ–û–ì–û–í–ê–Ø, –õ–ï–í–´–ô –ë–ï–†–ï–ì, –ê–í–¢–û–í–û–ö–ó–ê–õ, –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê, –ï–í–†–ê–ó–ò–Ø","4/3":"–¢–û–†–ê–ô–ì–´–†–û–í–ê, –¢–ò–¢–û–í, –ì–ê–ì–ê–†–ò–ù, –®–ê–ù–•–ê–ô, –ö–û–ú–ú–£–ù–ò–ó–ú, –ö–ë–ò, –ë–ï–õ–ö”®–õ, –ö–û–ú–°–û–ú–û–õ, –ê–õ–¨-–§–ê–†–ê–ë–ò","4/4":"–ù–û–í–û–°–¢–†–û–ô–ö–ê, –í–ó–õ–ï–¢–ö–ê, “ö–û–†“ö–´–¢-–ê–¢–ê, –¢”®–õ–ï –ë–ò, –ö–ò–†–û–í, –ù–ê–£–†–´–ó, –ù–û–í–´–ô –ë–ê–ó–ê–†, –ù–û–í.–ú–ï–ß–ï–¢–¨, –ê–ì–†–û–ü–†–û–ú, –¢–ê–°–ë”®–ì–ï–¢, –ó–ê–í–û–î–°–ö–ê–Ø, –°–ê–Ø–•–ê–¢, –°–ê–ë–ê–õ–ê“ö, –°–´“í–ê–ù–ê“ö, –ê–ù–ê –ú–ï–ù –ë–ê–õ–ê, –ò–ü–ü–û–î–†–û–ú","–°–ó":"–°–ê–ú–û–í–´–í–û–ó"};
let state={draft:[],archive:[],refAzs:[],refRoutes:[],refNotes:[],routeHints:{},pointBindings:{},transitList:[],autoSort:!1,contacts:{operator:[],expeditor:[]},editingId:null,archiveEditId:null,stash:[]};
let pressTimer=null,isLongPress=!1;
let tempHints={},tempBindings={},tempContacts={operator:[],expeditor:[]};
let currentHintRoute='',currentBindRoute='';
const startPress=id=>{isLongPress=!1;pressTimer=setTimeout(()=>{isLongPress=!0;openArchiveContextMenu(id)},600)};
const endPress=el=>{clearTimeout(pressTimer);const card=el?el.closest('.ac-card'):document.querySelector('.ac-card.pressed');if(card)card.classList.remove('pressed')};
const handleArchiveHeaderClick=el=>{if(!isLongPress){vibrate(10);el.nextElementSibling.classList.toggle('open')}};

function init(){try{loadData();if(!Array.isArray(state.refRoutes))state.refRoutes=DEFAULTS.routes;if(!Array.isArray(state.refAzs))state.refAzs=DEFAULTS.azs;renderRefLists();setupAutocomplete('azsInput','azsList',()=>state.refAzs);setupAutocomplete('factAddressInput','factAddressList',()=>state.refAzs);$('routeSelect').addEventListener('change',updateRouteHint);$('azsInput').addEventListener('input',e=>checkRouteBinding(e.target.value));$('noteInput').addEventListener('input',e=>{checkQuickNote(e.target.value);highlightActiveNotes(e.target.value)});['settingAzs','settingRoutes','settingNotes','settingAutoSort','settingHintText','settingBindText','settingTransitList'].forEach(id=>{const el=$(id);if(el)el.addEventListener('input',()=>{checkSettingsDirty()})});$('azsManagerSearch').addEventListener('input',renderAzsManager);setupKeyboardBehavior();setupBottomSheetSwipe();resetForm();renderDraft();renderArchive();prepareSettingsTab();requestAnimationFrame(()=>{document.getElementById('swipeTrack').dispatchEvent(new Event('scroll'));});switchTab('tab-input',$$('.nav-item')[0])}catch(e){console.error("Init failed:",e);fullReset()}}
function toggleAddressMode(){vibrate(10);const btn=$('btnToggleDiff');const block=$('diffAddressBlock');const isActive=btn.classList.toggle('active-diff');block.classList.toggle('active',isActive);if(isActive){const input=$('factAddressInput');if(!input.value)setTimeout(()=>input.focus(),100)}}
function toggleTransitMode(){vibrate(10);$('btnToggleTransit').classList.toggle('active-transit')}
function handleMainAction(){vibrate();const azs=$('azsInput').value.trim();const routeVal=$('routeSelect').value;if(!azs){vibrate([50,50,50]);return showCustomAlert('–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ê–ó–°')}if(!routeVal){vibrate([50,50,50]);return showCustomAlert('–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!')}const isDiff=$('btnToggleDiff').classList.contains('active-diff');const isTransit=$('btnToggleTransit').classList.contains('active-transit');const entry={id:state.editingId||Date.now(),azs,route:routeVal,amounts:Array.from($$('.amount-row input')).map(i=>i.value.trim()).filter(Boolean).join(' / '),isTransit:isTransit,isDiff:isDiff,factAddr:isDiff?$('factAddressInput').value.trim():'',note:$('noteInput').value.trim()};if(state.editingId){const idx=state.draft.findIndex(i=>i.id===state.editingId);if(idx!==-1)state.draft[idx]=entry;showCustomAlert('–ì–æ—Ç–æ–≤–æ','–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞')}else{state.draft.push(entry)}saveData();resetForm()}
function resetForm(){$('azsInput').value='';$('factAddressInput').value='';$('noteInput').value='';renderAmountInputs([]);$('routeSelect').value='';updateRouteHint();$('btnToggleDiff').classList.remove('active-diff');$('diffAddressBlock').classList.remove('active');$('btnToggleTransit').classList.remove('active-transit');['quickAddAzsBtn','quickAddFactBtn','quickAddNoteBtn'].forEach(id=>$(id).style.display='none');highlightActiveNotes('');state.editingId=null;$('mainActionBtn').textContent='–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫';$('cancelEditBtn').style.display='none';$('editModeBanner').style.display=state.archiveEditId?'flex':'none';updateSelectButtons();renderDraft()}
function renderDraft(){const list=$('draftList');if(state.autoSort)state.draft.sort((a,b)=>a.route.localeCompare(b.route));const count=state.draft.length;$('draftCount').textContent=count;const badge=$('navBadge');badge.textContent=count;badge.style.display=count>0?'flex':'none';if(count>0){badge.style.animation='none';badge.offsetHeight;badge.style.animation='popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'}$('archiveBtn').style.display=(count>0||state.archiveEditId)?'flex':'none';list.innerHTML='';if(count===0){list.innerHTML=`<div class="empty-state">${state.archiveEditId?'–ê—Ä—Ö–∏–≤ –æ—á–∏—â–µ–Ω':'–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç<br><small style="opacity:0.6">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–æ–≤–∞—è"</small>'}</div>`;return}state.draft.forEach((item,index)=>{const el=document.createElement('div');el.className=`card ${state.editingId===item.id?'editing-focus':''}`;el.dataset.id=item.id;let amountHtml=item.amounts?`<span class="u-tag tag-amount" style="margin:0">${item.amounts}</span>`:`<span class="u-tag tag-amount empty" style="margin:0">–ù–ï–¢ –°–£–ú–ú–´</span>`;let mainTagsHtml=`<span class="u-tag tag-route">${item.route}</span>`;if(item.isTransit)mainTagsHtml+=`<span class="u-tag tag-transit">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</span>`;let addressHtml=(item.isDiff&&item.factAddr)?`<div style="margin-top: 8px;"><span class="u-tag tag-address">‚ö†Ô∏è ${item.factAddr}</span></div>`:'';const noteHtml=item.note?`<div class="card-note" style="margin-top:8px">‚ÑπÔ∏è ${item.note}</div>`:'';el.innerHTML=`<div class="card-top"><div class="card-azs">${item.azs}</div>${amountHtml}</div><div class="card-tags">${mainTagsHtml}</div>${addressHtml}${noteHtml}`;setupDragItem(el,item,index);list.appendChild(el)});try{renderReports()}catch(e){}}
function cancelArchiveEdit(){showCustomConfirm('–í—ã—Ö–æ–¥','–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?','–í—ã–π—Ç–∏','–û—Ç–º–µ–Ω–∞',()=>exitArchiveEditMode())}
function loadForEdit(id){const item=state.draft.find(i=>i.id===id);if(!item)return;state.editingId=id;$('azsInput').value=item.azs;renderAmountInputs(item.amounts?item.amounts.split(' / '):[]);$('routeSelect').value=item.route;if(item.isTransit)$('btnToggleTransit').classList.add('active-transit');else $('btnToggleTransit').classList.remove('active-transit');if(item.isDiff){$('btnToggleDiff').classList.add('active-diff');$('diffAddressBlock').classList.add('active');$('factAddressInput').value=item.factAddr}else{$('btnToggleDiff').classList.remove('active-diff');$('diffAddressBlock').classList.remove('active')}$('noteInput').value=item.note||'';highlightActiveNotes(item.note||'');updateRouteHint();updateSelectButtons();$('mainActionBtn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';$('cancelEditBtn').style.display='block';switchTab('tab-input',$$('.nav-item')[0])}
function saveToArchive(){if(!state.draft.length)return;vibrate(40);if(state.archiveEditId)return handleUpdateArchive();showCustomConfirm('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–Ω—è','–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ –∞—Ä—Ö–∏–≤?','–ó–∞–≤–µ—Ä—à–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{state.archive.unshift({id:Date.now(),date:new Date().toLocaleDateString()+', '+new Date().toLocaleTimeString().slice(0,5),items:[...state.draft]});state.draft=[];saveData();renderDraft();renderArchive();resetForm();switchTab('tab-archive',$$('.nav-item')[3])})}
function renderArchive(){const c=$('archiveContainer');c.innerHTML='';if(state.archive.length===0){c.innerHTML='<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';return}state.archive.forEach(rec=>{const div=document.createElement('div');div.className='ac-card';if(state.archiveEditId===rec.id)div.classList.add('editing-focus');const groups={};rec.items.forEach(i=>{if(!groups[i.route])groups[i.route]=[];groups[i.route].push(i)});let contentHtml='';Object.keys(groups).sort().forEach(r=>{contentHtml+=`<div class="settings-header" style="margin:20px 16px 8px 16px; color:#6b7280; font-size:10px;">${r}</div>`;groups[r].forEach(item=>{let amountHtml=item.amounts?`<span class="u-tag tag-amount" style="margin:0">${item.amounts}</span>`:`<span class="u-tag tag-amount empty" style="margin:0">–ù–ï–¢ –°–£–ú–ú–´</span>`;let mainTagsHtml=`<span class="u-tag tag-route">${item.route}</span>`;if(item.isTransit)mainTagsHtml+=`<span class="u-tag tag-transit">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</span>`;let addressHtml=(item.isDiff&&item.factAddr)?`<div style="margin-top: 8px;"><span class="u-tag tag-address">‚ö†Ô∏è ${item.factAddr}</span></div>`:'';const noteHtml=item.note?`<div class="card-note" style="margin-top:8px">‚ÑπÔ∏è ${item.note}</div>`:'';contentHtml+=`<div class="card"><div class="card-top"><div class="card-azs">${item.azs}</div>${amountHtml}</div><div class="card-tags">${mainTagsHtml}</div>${addressHtml}${noteHtml}</div>`})});div.innerHTML=`<div class="ac-header" ontouchstart="startPress(${rec.id})" ontouchend="endPress()" onmousedown="startPress(${rec.id})" onmouseup="endPress()" onmouseleave="endPress()" onclick="handleArchiveHeaderClick(this)"><div class="ac-date">üìÖ ${rec.date}</div><div class="badge-counter" style="background:#333">${rec.items.length}</div></div><div class="ac-body">${contentHtml}<div style="height:12px;"></div></div>`;c.appendChild(div)})}
function editArchiveRecord(id){const rec=state.archive.find(r=>r.id===id);if(!rec)return;if(state.draft.length>0)state.stash=[...state.draft];state.archiveEditId=id;state.draft=[...rec.items];$('editModeBanner').style.display='flex';$('archiveBtn').innerHTML='<span>üíæ</span> –û–ë–ù–û–í–ò–¢–¨ –ê–†–•–ò–í';$('cancelArchiveEditBtn').style.display='block';saveData();renderDraft();switchTab('tab-list',$$('.nav-item')[1])}
function handleUpdateArchive(){showCustomConfirm('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ','–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤–µ?','–°–æ—Ö—Ä–∞–Ω–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{const idx=state.archive.findIndex(r=>r.id===state.archiveEditId);if(idx!==-1){state.archive[idx].items=[...state.draft]}exitArchiveEditMode()})}
function exitArchiveEditMode(){state.archiveEditId=null;state.draft=state.stash.length?[...state.stash]:[];state.stash=[];$('editModeBanner').style.display='none';$('archiveBtn').innerHTML='<span>üèÅ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å';$('cancelArchiveEditBtn').style.display='none';saveData();renderDraft();renderArchive();switchTab('tab-archive',$$('.nav-item')[3])}
function deleteArchiveRecord(id){showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ','–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?','–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{state.archive=state.archive.filter(r=>r.id!==id);saveData();renderArchive()})}
function clearAllArchive(){vibrate(50);showCustomConfirm('–û—á–∏—Å—Ç–∫–∞','–£–¥–∞–ª–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é?','–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë','–û—Ç–º–µ–Ω–∞',()=>{state.archive=[];saveData();renderArchive()})}
function prepareSettingsTab(){$('settingAzs').value=state.refAzs.join(', ');$('settingRoutes').value=state.refRoutes.join(', ');$('settingNotes').value=state.refNotes.join(', ');$('settingAutoSort').checked=state.autoSort;$('settingTransitList').value=state.transitList.join(', ');updateBadgesFromInputs();tempHints=JSON.parse(JSON.stringify(state.routeHints));tempBindings=JSON.parse(JSON.stringify(state.pointBindings));tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));updateSelectButtons();checkSettingsDirty()}
function saveSettings(){vibrate();state.refAzs=parseList($('settingAzs').value);state.refRoutes=parseList($('settingRoutes').value);state.refNotes=parseList($('settingNotes').value);state.autoSort=$('settingAutoSort').checked;state.transitList=parseList($('settingTransitList').value);state.routeHints={...tempHints};state.pointBindings={...tempBindings};state.contacts=JSON.parse(JSON.stringify(tempContacts));saveData();renderRefLists();renderDraft();const btn=$('saveSettingsBtn');btn.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ‚úî';checkSettingsDirty();setTimeout(()=>{if(btn.disabled)btn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'},2000);prepareSettingsTab()}
function checkSettingsDirty(){const btnSave=$('saveSettingsBtn'),btnCancel=$('cancelSettingsBtn');const valStr=id=>$(id).value.trim(),arrStr=arr=>arr.join(', ');const compareObjs=(objA,objB)=>{const keys=new Set([...Object.keys(objA||{}),...Object.keys(objB||{})]);for(let key of keys)if((objA[key]||'').trim()!==(objB[key]||'').trim())return!1;return!0};const hasChanges=valStr('settingAzs')!==arrStr(state.refAzs)||valStr('settingRoutes')!==arrStr(state.refRoutes)||valStr('settingNotes')!==arrStr(state.refNotes)||valStr('settingTransitList')!==arrStr(state.transitList)||$('settingAutoSort').checked!==state.autoSort||!compareObjs(tempHints,state.routeHints)||!compareObjs(tempBindings,state.pointBindings)||JSON.stringify(tempContacts)!==JSON.stringify(state.contacts);btnSave.disabled=!hasChanges;btnSave.classList.toggle('dirty',hasChanges);btnSave.textContent=hasChanges?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏':btnSave.textContent;btnCancel.style.display=hasChanges?'block':'none'}
function getLiveRouteList(){return parseList($('settingRoutes').value)}
function getLiveAzsList(){return parseList($('settingAzs').value)}
function renderReports(){if(!state.draft||state.draft.length===0){$('reportOperator').textContent='(–ü—É—Å—Ç–æ)';$('reportExpeditor').textContent='(–ü—É—Å—Ç–æ)';return}try{const fmt=(str)=>{if(!str)return'';return str.split('/').map(s=>s.trim().replace(/\s/g,'')+'~').join(' / ')};const opText=state.draft.map(i=>{const amountStr=i.amounts?fmt(i.amounts).replace(/~/g,'')+' | ':'';return`${i.azs} | ${amountStr}${i.route}`}).join('\n\n');$('reportOperator').textContent=opText||'(–ü—É—Å—Ç–æ)';const groups={};state.draft.forEach(i=>{const r=i.route||'–ë–µ–∑ –º–∞—Ä—à—Ä—É—Ç–∞';if(!groups[r])groups[r]=[];groups[r].push(i)});const routeOrder=state.refRoutes||[];const sortedKeys=Object.keys(groups).sort((a,b)=>{const idxA=routeOrder.indexOf(a);const idxB=routeOrder.indexOf(b);if(idxA!==-1&&idxB!==-1)return idxA-idxB;if(idxA!==-1)return-1;if(idxB!==-1)return 1;return a.localeCompare(b)});let expText='';sortedKeys.forEach(route=>{const items=groups[route];expText+=`=== ${route} ===\n\n`;const blockList=items.map(i=>{const lines=[];let l1=`üó∫ ${i.route||'?'}`;if(i.isTransit)l1+=' [–°–∫–ª–∞–¥/–û—Ñ–∏—Å]';lines.push(l1);if(i.amounts)lines.push(`üí∞ ${fmt(i.amounts)}`);if(i.note)lines.push(`‚ÑπÔ∏è ${i.note}`);let header=`üìÑ ${i.azs}`;if(i.isDiff&&i.factAddr)header+=` ‚ûú ${i.factAddr}`;lines.forEach((l,idx)=>{const prefix=(idx===lines.length-1)?'\n ‚ïö‚ïê':'\n ‚ï†‚ïê';header+=prefix+l});return header});expText+=blockList.join('\n\n')+'\n\n'});$('reportExpeditor').textContent=expText.trim()||'(–ü—É—Å—Ç–æ)'}catch(e){console.error("Report Error:",e);$('reportExpeditor').textContent="–û—à–∏–±–∫–∞: "+e.message}}
function copyReportText(text){if(!text)return;const success=()=>{vibrate([30,50,30]);showCustomAlert('–ì–æ—Ç–æ–≤–æ','–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!')};if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(success).catch(err=>console.error(err))}else{const ta=document.createElement("textarea");ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);success()}}
function loadData(){state.draft=DB.get('tp_currentDraft',[]);state.archive=DB.get('tp_tradeArchive',[]);state.refAzs=DB.get('tp_myAzs',DEFAULTS.azs);state.refRoutes=DB.get('tp_myRoutes',DEFAULTS.routes);state.refNotes=DB.get('tp_myNotes',DEFAULTS.notes);state.routeHints=DB.get('tp_routeHints',DEFAULT_HINTS);state.pointBindings=DB.get('tp_pointBindings',{});state.autoSort=DB.get('tp_autoSort',!1);state.stash=DB.get('tp_stash',[]);state.transitList=DB.get('tp_transitList',[]);state.contacts=DB.get('tp_contacts',{operator:[],expeditor:[]})}
function saveData(){DB.set('tp_currentDraft',state.draft);DB.set('tp_tradeArchive',state.archive);DB.set('tp_myAzs',state.refAzs);DB.set('tp_myRoutes',state.refRoutes);DB.set('tp_myNotes',state.refNotes);DB.set('tp_routeHints',state.routeHints);DB.set('tp_pointBindings',state.pointBindings);DB.set('tp_autoSort',state.autoSort);DB.set('tp_stash',state.stash);DB.set('tp_transitList',state.transitList);DB.set('tp_contacts',state.contacts)}
function setupAutocomplete(inputId,listId,dataGetter){const input=$(inputId),list=$(listId);const doSearch=()=>{const rawVal=input.value;const searchCode=getSearchCode(rawVal);list.innerHTML='';if(!rawVal){list.style.display='none';return}const matches=dataGetter().filter(item=>getSearchCode(item).includes(searchCode));if(matches.length){list.style.display='block';vibrate();matches.forEach(m=>{const d=document.createElement('div');d.className='autocomplete-item';d.textContent=m;d.onclick=()=>{vibrate(15);input.value=m;list.style.display='none';checkRouteBinding(m)};list.appendChild(d)})}else{list.style.display='none'}};input.addEventListener('input',doSearch);input.addEventListener('focus',doSearch);input.addEventListener('blur',()=>{setTimeout(()=>{list.style.display='none'},200)})}
function findOwnerInBindings(azsName,bindingsObj,currentKey){const v=azsName.toLowerCase();for(const[key,str]of Object.entries(bindingsObj)){if(key===currentKey)continue;if((str||'').split(',').map(s=>s.trim().toLowerCase()).includes(v))return key}return null}
function checkRouteBinding(val){const v=val.trim().toLowerCase();for(const[r,pts]of Object.entries(state.pointBindings)){if(pts&&pts.split(',').map(s=>s.trim().toLowerCase()).includes(v)){$('routeSelect').value=r;updateRouteHint();updateSelectButtons();break}}if(state.transitList.some(t=>t.toLowerCase()===v)){$('btnToggleTransit').classList.add('active-transit')}const exists=state.refAzs.some(x=>x.toLowerCase()===v);$('quickAddAzsBtn').style.display=(!exists&&v.length)?'flex':'none'}
function showCustomModal(title,text,buttons){vibrate(30);$('cmTitle').textContent=title;$('cmText').textContent=text;$('cmInput').style.display='none';const btns=$('cmButtons');btns.innerHTML='';buttons.forEach(b=>{const btn=document.createElement('button');btn.className=`cm-btn ${b.cls}`;btn.textContent=b.txt;btn.onclick=b.action?()=>{vibrate(10);closeCustomModal();b.action()}:()=>{vibrate(10);closeCustomModal()};btns.appendChild(btn)});$('customModal').classList.add('active')}
const showCustomAlert=(title,text)=>showCustomModal(title,text,[{txt:'–û–ö',cls:'cm-confirm'}]);
const showCustomConfirm=(title,text,okLabel,cancelLabel,onOk)=>showCustomModal(title,text,[{txt:cancelLabel,cls:'cm-cancel'},{txt:okLabel,cls:'cm-confirm',action:onOk}]);
const closeCustomModal=()=>$('customModal').classList.remove('active');
function openRouteSheet(){const cur=$('routeSelect').value;openBottomSheet(state.refRoutes,v=>{$('routeSelect').value=v;updateRouteHint();updateSelectButtons()},'–ú–∞—Ä—à—Ä—É—Ç',cur)}
function openBottomSheet(items,onSelect,title,selected){vibrate();$('bsHeader').textContent=title;$('bsContent').innerHTML='';items.forEach(i=>{const d=document.createElement('div');d.className='bs-item';d.textContent=i;if(i===selected)d.classList.add('selected');d.onclick=()=>{vibrate(10);onSelect(i);closeBottomSheet()};$('bsContent').appendChild(d)});$('bottomSheet').classList.add('active')}
function closeBottomSheet(e){if(!e||e.target.classList.contains('bs-overlay')){$('bottomSheet').classList.remove('active');$('bsPanel').style.transform=''}}
function openNoteSheet(){vibrate();const content=$('bsContent');$('bsHeader').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è';content.innerHTML='<div id="sheetChipsWrapper" class="chips-wrapper" style="max-height: none; justify-content: flex-start; margin-bottom: 20px;"></div>';const wrapper=$('sheetChipsWrapper');const currentParts=$('noteInput').value.split(',').map(s=>s.trim().toLowerCase());state.refNotes.forEach(note=>{const chip=document.createElement('div');chip.className='chip';chip.style.cssText="padding:8px 16px; font-size:14px;";chip.textContent=note;if(currentParts.includes(note.toLowerCase()))chip.classList.add('active');chip.onclick=()=>{vibrate(10);toggleNoteValue(note);};wrapper.appendChild(chip)});const btnDone=document.createElement('button');btnDone.className='btn-common btn-main';btnDone.textContent='–ì–æ—Ç–æ–≤–æ / –ó–∞–∫—Ä—ã—Ç—å';btnDone.onclick=()=>$('bottomSheet').classList.remove('active');content.appendChild(btnDone);$('bottomSheet').classList.add('active')}
function toggleNoteValue(note){const inp=$('noteInput');let parts=parseList(inp.value);const idx=parts.findIndex(p=>p.toLowerCase()===note.toLowerCase());if(idx>=0)parts.splice(idx,1);else parts.push(note);inp.value=parts.join(', ');inp.dispatchEvent(new Event('input'))}
function renderAmountInputs(vals){$('amountsContainer').innerHTML='';vals.forEach(addAmountInputToDom)}
function addAmountField(){vibrate();addAmountInputToDom('')}
function addAmountInputToDom(val){const d=document.createElement('div');d.className='amount-row';d.innerHTML=`<input type="number" placeholder="–°—É–º–º–∞" value="${val}"><button class="btn-remove" onclick="vibrate();this.parentElement.remove()">‚úï</button>`;$('amountsContainer').appendChild(d)}
function updateSelectButtons(){const val=$('routeSelect').value;const btn=$('routeSelectBtn');if(val){btn.textContent=val;btn.style.color='var(--text-main)';btn.style.opacity='1'}else{btn.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...';btn.style.color='var(--text-muted)';btn.style.opacity='0.7'}}
function checkQuickNote(val){const v=val.trim().toLowerCase();$('quickAddNoteBtn').style.display=(!v||state.refNotes.some(n=>n.toLowerCase()===v))?'none':'flex'}
function genericQuickAdd(list,inputId,btnId,msg){list.push($(inputId).value.trim());saveData();$(btnId).style.display='none';if(msg)showCustomAlert('OK',msg)}
function highlightActiveNotes(val){const parts=val.split(',').map(s=>s.trim().toLowerCase());const chips=$$('#sheetChipsWrapper .chip');if(chips.length){chips.forEach(c=>{c.classList.toggle('active',parts.includes(c.textContent.toLowerCase()))})}}
function updateRouteHint(){const val=$('routeSelect').value;let t=state.routeHints[val]||'';if(!t)for(const k in state.routeHints)if(val.startsWith(k)){t=state.routeHints[k];break}$('routeHint').textContent=t?`üëâ ${t}`:''}
function openRouteCheatSheet(){let h='<div class="p-0">';for(const[k,v]of Object.entries(state.routeHints))h+=`<div class="cheat-row"><div class="cheat-route">${k}</div><div class="cheat-desc">${v}</div></div>`;$('cheatSheetContent').innerHTML=h+'</div>';$('routeCheatModal').classList.add('active')}
function closeRouteCheatSheet(){$('routeCheatModal').classList.remove('active')}
function exportDb(){const d={meta:{date:new Date},draft:state.draft,archive:state.archive,settings:{refAzs:state.refAzs,refRoutes:state.refRoutes,refNotes:state.refNotes,routeHints:state.routeHints,pointBindings:state.pointBindings,autoSort:state.autoSort,contacts:state.contacts,transitList:state.transitList}};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`TP_Backup_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a)}
function importDb(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(!d.settings||!d.archive)throw new Error;showCustomConfirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ','–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞?','–ó–∞–º–µ–Ω–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{DB.set('tp_currentDraft',d.draft||[]);DB.set('tp_tradeArchive',d.archive||[]);DB.set('tp_myAzs',d.settings.refAzs);DB.set('tp_myRoutes',d.settings.refRoutes);DB.set('tp_myNotes',d.settings.refNotes);DB.set('tp_routeHints',d.settings.routeHints);DB.set('tp_pointBindings',d.settings.pointBindings);DB.set('tp_autoSort',d.settings.autoSort);DB.set('tp_contacts',d.settings.contacts||{operator:[],expeditor:[]});DB.set('tp_transitList',d.settings.transitList||[]);location.reload()})}catch(err){console.error(err);showCustomAlert('–û—à–∏–±–∫–∞','–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª')}};r.readAsText(f);input.value=''}
function fullReset(){vibrate([50,100,50]);showCustomConfirm('–°–±—Ä–æ—Å','–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ –∑–∞–≤–æ–¥—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫? –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—Ç—Å—è.','–°–ë–†–û–°–ò–¢–¨','–û—Ç–º–µ–Ω–∞',()=>{localStorage.clear();location.reload()})}
function deleteItem(idx){showCustomConfirm('–£–¥–∞–ª–∏—Ç—å','–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?','–î–∞','–ù–µ—Ç',()=>{state.draft.splice(idx,1);saveData();renderDraft()})}
function duplicateItem(idx){state.draft.splice(idx+1,0,{...state.draft[idx],id:Date.now()});saveData();renderDraft()}
function filterChips(wrapperId,val){const v=val.toLowerCase();$$(`#${wrapperId} .chip`).forEach(c=>c.style.display=c.dataset.val.includes(v)?'block':'none')}
function changeArchiveTime(id){const picker=$('archiveDatePicker');const rec=state.archive.find(r=>r.id===id);if(!rec)return;try{const[dPart,tPart]=rec.date.split(', ');const[day,month,year]=dPart.split('.');picker.value=`${year}-${month}-${day}T${tPart}`}catch(e){}picker.onchange=function(){if(this.value){const d=new Date(this.value);const day=String(d.getDate()).padStart(2,'0'),month=String(d.getMonth()+1).padStart(2,'0'),year=d.getFullYear(),time=d.toLocaleTimeString().slice(0,5);rec.date=`${day}.${month}.${year}, ${time}`;state.archive.sort((a,b)=>{const parseDate=str=>{try{const[dateS,timeS]=str.split(', ');const[dd,mm,yyyy]=dateS.split('.');return new Date(`${yyyy}-${mm}-${dd}T${timeS}`).getTime()}catch(e){return 0}};return parseDate(b.date)-parseDate(a.date)});saveData();renderArchive();showCustomAlert('–ì–æ—Ç–æ–≤–æ','–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞, —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.')}};try{picker.showPicker()}catch{picker.click()}}
function renderRefLists(){const s=$('routeSelect');s.innerHTML='<option value="" disabled selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';state.refRoutes.forEach(i=>s.add(new Option(i,i)));updateSelectButtons()}
function revertSettings(){prepareSettingsTab();tempHints=JSON.parse(JSON.stringify(state.routeHints));tempBindings=JSON.parse(JSON.stringify(state.pointBindings));tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));updateBadgesFromInputs();showCustomAlert('–°–±—Ä–æ—à–µ–Ω–æ','–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é.');checkSettingsDirty()}
function openBindAzsSheet(){vibrate();if(!currentBindRoute)return showCustomAlert('–û—à–∏–±–∫–∞','–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç');const content=$('bsContent');$('bsHeader').textContent=`–ü—Ä–∏–≤—è–∑–∫–∞ –∫: ${currentBindRoute}`;content.innerHTML=`<input type="text" placeholder="–ü–æ–∏—Å–∫ –ê–ó–°..." class="input-sm" style="margin-bottom:10px;" oninput="filterChips('sheetBindWrapper',this.value)"><div id="sheetBindWrapper" class="chips-wrapper" style="max-height: 60vh; justify-content: flex-start;"></div><button class="btn-common btn-main mt-10" onclick="$('bottomSheet').classList.remove('active')">–ì–æ—Ç–æ–≤–æ</button>`;const wrapper=$('sheetBindWrapper');const currentList=parseList(tempBindings[currentBindRoute]||"");const currentLower=currentList.map(s=>s.toLowerCase());getLiveAzsList().forEach(azs=>{const azsLow=azs.toLowerCase();const btn=document.createElement('div');btn.className='chip';btn.style.padding="8px 14px";btn.textContent=azs;btn.dataset.val=azsLow;const owner=findOwnerInBindings(azs,tempBindings,currentBindRoute);const isActive=currentLower.includes(azsLow);if(isActive)btn.classList.add('active');else if(owner)btn.classList.add('taken');btn.onclick=()=>{const toggleCurrent=()=>{let list=parseList(tempBindings[currentBindRoute]||"");const idx=list.findIndex(x=>x.toLowerCase()===azsLow);if(idx>=0){list.splice(idx,1);btn.classList.remove('active')}else{list.push(azs);btn.classList.add('active')}const newVal=list.join(', ');tempBindings[currentBindRoute]=newVal;btn.classList.remove('taken');checkSettingsDirty();renderBindingsManager()};if(owner&&!btn.classList.contains('active')){$('bottomSheet').classList.remove('active');showCustomConfirm('–ö–æ–Ω—Ñ–ª–∏–∫—Ç',`"${azs}" —É–∂–µ —É –º–∞—Ä—à—Ä—É—Ç–∞ "${owner}". –ó–∞–±—Ä–∞—Ç—å —Å–µ–±–µ?`,'–ó–∞–±—Ä–∞—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let oldList=parseList(tempBindings[owner]).filter(x=>x.toLowerCase()!==azsLow);tempBindings[owner]=oldList.join(', ');toggleCurrent();openBindAzsSheet()});return}vibrate(10);toggleCurrent()};wrapper.appendChild(btn)});$('bottomSheet').classList.add('active')}
function handleSendReport(type){const text=$(`report${type.charAt(0).toUpperCase()+type.slice(1)}`).textContent;if(!text||text==='(–ü—É—Å—Ç–æ)')return showCustomAlert('–ü—É—Å—Ç–æ','–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');const contacts=state.contacts[type]||[];if(contacts.length===0){showCustomAlert('–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤',`–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è "${type==='operator'?'–û–ø–µ—Ä–∞—Ç–æ—Ä–∞':'–≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä–∞'}" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.`);return}if(contacts.length===1){sendToWhatsapp(contacts[0].phone,text)}else{const content=$('bsContent');$('bsHeader').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è';content.innerHTML='';contacts.forEach(c=>{const btn=document.createElement('button');btn.className='bs-item';btn.innerHTML=`<span>${c.name}</span> <span style="font-size:12px; color:#888;">${c.phone}</span>`;btn.onclick=()=>{sendToWhatsapp(c.phone,text);$('bottomSheet').classList.remove('active')};content.appendChild(btn)});$('bottomSheet').classList.add('active');vibrate()}}
function sendToWhatsapp(phone,text){let cleanPhone=phone.replace(/\D/g,'');if(cleanPhone.length===11&&cleanPhone.startsWith('8'))cleanPhone='7'+cleanPhone.slice(1);if(cleanPhone.length===10)cleanPhone='7'+cleanPhone;window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(text)}`,'_blank')}
function setupBottomSheetSwipe() {
    // –ù–∞—Ö–æ–¥–∏–º –í–°–ï –ø–∞–Ω–µ–ª–∏ (—à—Ç–æ—Ä–∫–∏) –≤ –ø—Ä–æ–µ–∫—Ç–µ
    const panels = document.querySelectorAll('.bs-panel');

    panels.forEach(panel => {
        let bsStart = 0;
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        const content = panel.querySelector('.bs-content'); 

        panel.addEventListener('touchstart', e => {
            // –†–∞–∑—Ä–µ—à–∞–µ–º –∂–µ—Å—Ç, –µ—Å–ª–∏ –∫–æ—Å–Ω—É–ª–∏—Å—å —à–∞–ø–∫–∏ –ò–õ–ò –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ–∫—Ä—É—á–µ–Ω –≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö
            const isHeader = e.target.closest('.bs-header') || e.target === panel;
            const isContentTop = content ? (content.scrollTop <= 0) : true;

            if (isHeader || isContentTop) {
                bsStart = e.touches[0].clientY;
                panel.style.transition = 'none'; // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –ø–∞–ª—å—Ü–µ–º
            } else {
                bsStart = 0;
            }
        }, { passive: true });

        panel.addEventListener('touchmove', e => {
            if (!bsStart) return;
            let delta = e.touches[0].clientY - bsStart;

            // –ï—Å–ª–∏ —Ç—è–Ω–µ–º –≤–Ω–∏–∑ (delta > 0)
            if (delta > 0) {
                if (e.cancelable) e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                panel.style.transform = `translateY(${delta}px)`;
            }
        }, { passive: false });

        panel.addEventListener('touchend', e => {
            if (!bsStart) return;
            let delta = e.changedTouches[0].clientY - bsStart;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            panel.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1)';

            // –ï—Å–ª–∏ –ø—Ä–æ—Ç—è–Ω—É–ª–∏ –≤–Ω–∏–∑ –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 100px - –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (delta > 100) {
                const overlay = panel.closest('.bs-overlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                    if (document.activeElement) document.activeElement.blur();
                }
                // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                setTimeout(() => { panel.style.transform = ''; }, 300);
            } else {
                // –ï—Å–ª–∏ –º–∞–ª–æ –ø—Ä–æ—Ç—è–Ω—É–ª–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
                panel.style.transform = '';
            }
            bsStart = 0;
        });
    });
}
const track=document.getElementById('swipeTrack');const TABS=['tab-input','tab-list','tab-reports','tab-archive','tab-settings'];const NAV_ITEMS=document.querySelectorAll('.nav-item');let navPill=document.querySelector('.nav-pill')||(()=>{const p=document.createElement('div');p.className='nav-pill';document.querySelector('.bottom-nav').appendChild(p);return p})();let currentIndex=0,isRestoring=!1,isTicking=!1;const colStart={r:156,g:163,b:175};const colEnd={r:59,g:130,b:246};
function updateNavOnScroll(){if(isRestoring){isTicking=!1;return}const width=track.offsetWidth;if(!width){isTicking=!1;return}const scrollLeft=track.scrollLeft,progress=scrollLeft/width;navPill.style.transform=`translate3d(${progress*100}%, 0, 0)`;NAV_ITEMS.forEach((btn,index)=>{const icon=btn.querySelector('.nav-icon'),distance=Math.abs(progress-index),strength=Math.max(0,1-distance);if(icon){icon.style.transform=`translateY(${-4*strength}px) scale(${1+(strength*0.15)})`}btn.style.color=`rgb(${Math.round(colStart.r+(colEnd.r-colStart.r)*strength)}, ${Math.round(colStart.g+(colEnd.g-colStart.g)*strength)}, ${Math.round(colStart.b+(colEnd.b-colStart.b)*strength)})`});const newIndex=Math.round(progress);if(newIndex!==currentIndex){if(currentIndex===4&&newIndex!==4){const btnSave=$('saveSettingsBtn');if(btnSave&&btnSave.classList.contains('dirty')){if(document.querySelector('.custom-modal.active')){track.scrollTo({left:4*width,behavior:'auto'});isTicking=!1;return}isRestoring=!0;track.scrollTo({left:4*width,behavior:'auto'});showUnsavedConfirm(newIndex);setTimeout(()=>{isRestoring=!1},100);isTicking=!1;return}}currentIndex=newIndex;NAV_ITEMS.forEach(b=>b.classList.remove('active'));if(NAV_ITEMS[currentIndex])NAV_ITEMS[currentIndex].classList.add('active');if(document.activeElement?.tagName==='INPUT')document.activeElement.blur();try{if(TABS[currentIndex]==='tab-reports')renderReports();if(TABS[currentIndex]==='tab-settings')prepareSettingsTab()}catch(e){}vibrate(5)}isTicking=!1}
track.addEventListener('scroll',()=>{if(!isTicking){window.requestAnimationFrame(updateNavOnScroll);isTicking=!0}},{passive:!0});
function goToTab(index,force=!1){if(!force&&currentIndex===4&&index!==4){const btnSave=$('saveSettingsBtn');if(btnSave&&btnSave.classList.contains('dirty')){showUnsavedConfirm(index);return}}track.scrollTo({left:index*track.offsetWidth,behavior:'smooth'})}
window.switchTab=function(tabId,navBtn){const idx=TABS.indexOf(tabId);if(currentIndex===idx){const activeEl=$(tabId);if(activeEl)activeEl.scrollTo({top:0,behavior:'smooth'});return}vibrate();goToTab(idx)};
function showUnsavedConfirm(targetIndex){showCustomConfirm('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–∞–¥—É—Ç. –£–π—Ç–∏?','–°–±—Ä–æ—Å–∏—Ç—å –∏ —É–π—Ç–∏','–û—Å—Ç–∞—Ç—å—Å—è',()=>{revertSettings();isRestoring=!1;goToTab(targetIndex,!0)})}
function openItemContextMenu(id,index,item){const reportText=`${item.azs} | ${item.amounts?item.amounts+' | ':''}${item.route}`;$('bsContent').innerHTML='';const btns=[{txt:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',icon:'‚úèÔ∏è',action:()=>loadForEdit(id),warning:!0},{txt:'–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é',icon:'üìÑ',action:()=>duplicateItem(index)},{txt:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç',icon:'üìã',action:()=>copyReportText(reportText)},{txt:'–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É',icon:'üóë',action:()=>deleteItem(index),danger:!0}];btns.forEach(i=>{const btn=document.createElement('button');btn.className=`bs-action-btn ${i.danger?'danger':''}`;btn.innerHTML=`<span ${i.warning?'style="color:var(--warning)"':''}>${i.icon}</span> ${i.warning?'<b>'+i.txt+'</b>':i.txt}`;btn.onclick=()=>{vibrate(10);i.action();closeBottomSheet()};$('bsContent').appendChild(btn)});$('bsHeader').textContent=item.azs;$('bottomSheet').classList.add('active');vibrate()}
function openArchiveContextMenu(id){const rec=state.archive.find(r=>r.id===id);if(!rec)return;$('bsContent').innerHTML='';const btns=[{txt:'–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É/–≤—Ä–µ–º—è',icon:'üïí',action:()=>changeArchiveTime(id)},{txt:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º',icon:'‚úèÔ∏è',action:()=>editArchiveRecord(id),warning:!0},{txt:'–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å',icon:'üóë',action:()=>deleteArchiveRecord(id),danger:!0}];btns.forEach(i=>{const btn=document.createElement('button');btn.className=`bs-action-btn ${i.danger?'danger':''}`;btn.innerHTML=`<span ${i.warning?'style="color:var(--warning)"':''}>${i.icon}</span> ${i.warning?'<b>'+i.txt+'</b>':i.txt}`;btn.onclick=()=>{vibrate(10);i.action();closeBottomSheet()};$('bsContent').appendChild(btn)});$('bsHeader').textContent=`–ê—Ä—Ö–∏–≤: ${rec.date}`;$('bottomSheet').classList.add('active');vibrate()}
function setupKeyboardBehavior(){const viewport=window.visualViewport;let initialHeight=window.innerHeight;window.addEventListener('resize',()=>{if(!document.body.classList.contains('keyboard-open')&&window.innerHeight>initialHeight)initialHeight=window.innerHeight});function checkKeyboard(){if(!viewport)return!1;return viewport.height<(initialHeight*0.80)}function handleStateChange(){const isKeyboardOpen=checkKeyboard();document.body.classList.toggle('keyboard-open',isKeyboardOpen);if(isKeyboardOpen)centerActiveElement()}function centerActiveElement(){const activeEl=document.activeElement;if(activeEl&&(activeEl.tagName==='INPUT'||activeEl.tagName==='TEXTAREA'))setTimeout(()=>{activeEl.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'})},100)}if(viewport){viewport.addEventListener('resize',handleStateChange);viewport.addEventListener('scroll',handleStateChange)}document.querySelectorAll('input, textarea').forEach(input=>{input.addEventListener('focus',()=>{setTimeout(()=>{if(checkKeyboard()||(window.innerHeight<initialHeight*0.8)){document.body.classList.add('keyboard-open');centerActiveElement()}},300)});input.addEventListener('blur',()=>{setTimeout(()=>{if(!checkKeyboard()){document.body.classList.remove('keyboard-open')}},100)})})}
let dragTimer=null,dragClone=null,dragSrcEl=null,isDraggingMode=!1,startX=0,startY=0,lastTouchY=0;let scrollInterval=null,scrollSpeed=0;const AUTO_SCROLL_TOP_ZONE=140,AUTO_SCROLL_BOTTOM_ZONE=140,MAX_SCROLL_SPEED=20;
function setupDragItem(el,item,index){el.addEventListener('touchstart',e=>handleStart(e,el,item,index),{passive:!1});el.addEventListener('touchmove',handleMove,{passive:!1});el.addEventListener('touchend',handleEnd);el.addEventListener('touchcancel',forceCancelDrag);el.addEventListener('mousedown',e=>handleStart(e,el,item,index));el.addEventListener('mousemove',handleMove);el.addEventListener('mouseup',handleEnd);el.addEventListener('mouseleave',handleEnd)}
function handleStart(e,el,item,index){if(e.button===2)return;if(e.touches&&e.touches.length>1)return;if(state.autoSort){el.onclick=()=>openItemContextMenu(item.id,index,item);return}isDraggingMode=!1;dragSrcEl=el;if(e.touches){startX=e.touches[0].clientX;startY=e.touches[0].clientY}else{startX=e.clientX;startY=e.clientY}clearTimeout(dragTimer);dragTimer=setTimeout(()=>{startDrag(el,item,index)},400)}
function handleMove(e){if(!dragSrcEl)return;const clientY=(e.touches)?e.touches[0].clientY:e.clientY;const clientX=(e.touches)?e.touches[0].clientX:e.clientX;lastTouchY=clientY;if(!isDraggingMode){const moveX=Math.abs(clientX-startX);const moveY=Math.abs(clientY-startY);if(moveY>6||moveX>6){clearTimeout(dragTimer);dragSrcEl=null}return}if(e.cancelable)e.preventDefault();if(e.touches&&e.touches.length>1){forceCancelDrag();return}if(dragClone){const h=dragClone.offsetHeight;const w=dragClone.offsetWidth;dragClone.style.top=`${clientY-h/2}px`;dragClone.style.left=`${clientX-w/2}px`;dragClone.style.display='none';let elemBelow=document.elementFromPoint(clientX,clientY);dragClone.style.display='block';if(!elemBelow)return;let cardBelow=elemBelow.closest('.card');if(cardBelow&&cardBelow!==dragSrcEl&&cardBelow.parentNode===dragSrcEl.parentNode){const rect=cardBelow.getBoundingClientRect();const offset=clientY-rect.top-rect.height/2;const parent=cardBelow.parentNode;if(offset<0&&dragSrcEl.nextElementSibling!==cardBelow){parent.insertBefore(dragSrcEl,cardBelow);vibrate(20)}else if(offset>=0&&dragSrcEl.previousElementSibling!==cardBelow){parent.insertBefore(dragSrcEl,cardBelow.nextSibling);vibrate(20)}}}handleAutoScroll(clientY)}
function handleEnd(e){clearTimeout(dragTimer);if(isDraggingMode){stopDrag()}else{if(dragSrcEl){const id=parseInt(dragSrcEl.dataset.id);if(id){const currentIdx=state.draft.findIndex(x=>x.id===id);const item=state.draft[currentIdx];if(item)openItemContextMenu(id,currentIdx,item)}}}cleanupGlobal()}
function forceCancelDrag(){clearTimeout(dragTimer);if(isDraggingMode)stopDrag();cleanupGlobal()}
function cleanupGlobal(){dragSrcEl=null;isDraggingMode=!1;startX=0;startY=0;stopAutoScroll()}
function startDrag(el,item,index){isDraggingMode=!0;vibrate(50);document.body.classList.add('dragging-active');const rect=el.getBoundingClientRect();dragClone=el.cloneNode(!0);dragClone.classList.add('card-clone');dragClone.style.width=`${rect.width}px`;dragClone.style.height=`${rect.height}px`;dragClone.style.top=`${rect.top}px`;dragClone.style.left=`${rect.left}px`;document.body.appendChild(dragClone);el.classList.add('is-dragging-placeholder')}
function stopDrag(){stopAutoScroll();document.body.classList.remove('dragging-active');if(dragSrcEl){dragSrcEl.classList.remove('is-dragging-placeholder')}if(dragClone){dragClone.remove();dragClone=null}reorderState()}
function reorderState(){const listContainer=$('draftList');if(!listContainer)return;const newOrderIds=Array.from(listContainer.children).map(child=>parseInt(child.dataset.id)).filter(id=>!isNaN(id));if(newOrderIds.length===0)return;const newDraft=[];newOrderIds.forEach(id=>{const item=state.draft.find(x=>x.id===id);if(item)newDraft.push(item)});state.draft=newDraft;saveData()}
function handleAutoScroll(clientY){const viewportH=window.innerHeight;scrollSpeed=0;if(clientY<AUTO_SCROLL_TOP_ZONE){const distance=AUTO_SCROLL_TOP_ZONE-clientY;const intensity=Math.min(1,distance/60);scrollSpeed=-(MAX_SCROLL_SPEED*intensity)}else if(clientY>(viewportH-AUTO_SCROLL_BOTTOM_ZONE)){const distance=clientY-(viewportH-AUTO_SCROLL_BOTTOM_ZONE);const intensity=Math.min(1,distance/60);scrollSpeed=MAX_SCROLL_SPEED*intensity}if(scrollSpeed!==0&&!scrollInterval){autoScrollFrame()}}
function autoScrollFrame(){if(!isDraggingMode||scrollSpeed===0){stopAutoScroll();return}const listContainer=document.getElementById('tab-list');if(listContainer){listContainer.scrollTop+=scrollSpeed}scrollInterval=requestAnimationFrame(autoScrollFrame)}
function stopAutoScroll(){scrollSpeed=0;if(scrollInterval){cancelAnimationFrame(scrollInterval);scrollInterval=null}}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const installBtn=$('installAppBtn');if(installBtn)installBtn.style.display='block'});
async function installPWA(){if(!deferredPrompt)return;deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;if(outcome==='accepted'){const installBtn=$('installAppBtn');if(installBtn)installBtn.style.display='none'}deferredPrompt=null}
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js?v=11.6').then(reg=>{reg.update();reg.addEventListener('updatefound',()=>{const newWorker=reg.installing;newWorker.addEventListener('statechange',()=>{if(newWorker.state==='installed'&&navigator.serviceWorker.controller){window.location.reload()}})})}).catch(err=>console.log('SW err:',err))});navigator.serviceWorker.addEventListener('controllerchange',()=>{window.location.reload()})}
function updateBadgesFromInputs(){$('azsCountBadge').textContent=parseList($('settingAzs').value).length;$('routesCountBadge').textContent=parseList($('settingRoutes').value).length;$('notesCountBadge').textContent=parseList($('settingNotes').value).length;$('contactsCountBadge').textContent=(tempContacts.operator?tempContacts.operator.length:0)+(tempContacts.expeditor?tempContacts.expeditor.length:0);let totalBindings=0;Object.values(tempBindings).forEach(val=>{if(val)totalBindings+=parseList(val).length});const bindBadge=$('bindingsCountBadge');if(bindBadge)bindBadge.textContent=totalBindings;const transitBadge=$('transitCountBadge');if(transitBadge)transitBadge.textContent=parseList($('settingTransitList').value).length}

// RENDER HELPERS
function renderManagerList(containerId,list,onClick,itemRenderer,emptyText='–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç'){const container=$(containerId);if(!container)return;container.innerHTML='';if(!list||list.length===0){container.innerHTML=`<div class="empty-list-stub">${emptyText}</div>`;return}list.forEach(item=>{const el=document.createElement('div');el.className='manager-card';el.onclick=()=>onClick(item);el.innerHTML=itemRenderer(item);container.appendChild(el)})}
function openAzsManagerScreen(){vibrate();setAzsMode('list');renderAzsManager();$('view-azs-manager').classList.add('active')}
function closeAzsManagerScreen(){if($('azsMassEditContainer').style.display==='flex'){saveAzsMassEdit(true)}$('view-azs-manager').classList.remove('active');updateBadgesFromInputs()}
function setAzsMode(mode){vibrate(10);const listCont=$('azsListContainer'),massCont=$('azsMassEditContainer'),btnAddWrapper=document.querySelector('#view-azs-manager .header-action'),btnList=$('scBtnList'),btnText=$('scBtnText');if(mode==='list'){if(massCont.style.display==='flex'){saveAzsMassEdit(true)}listCont.style.display='block';massCont.style.display='none';if(btnAddWrapper)btnAddWrapper.style.visibility='visible';btnList.classList.add('active');btnText.classList.remove('active');renderAzsManager()}else{listCont.style.display='none';massCont.style.display='flex';if(btnAddWrapper)btnAddWrapper.style.visibility='hidden';btnList.classList.remove('active');btnText.classList.add('active');$('azsMassInput').value=parseList($('settingAzs').value).join('\n')}}
function saveAzsMassEdit(silent=false){const raw=$('azsMassInput').value;let items=raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);items=[...new Set(items)];items.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));const newVal=items.join(', ');const oldVal=$('settingAzs').value;if(oldVal===newVal)return;$('settingAzs').value=newVal;checkSettingsDirty();if(!silent)showCustomAlert('–ì–æ—Ç–æ–≤–æ',`–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω.`)}
function renderAzsManager(){const searchText=$('azsManagerSearch').value.toLowerCase().trim();let list=parseList($('settingAzs').value);if(searchText)list=list.filter(azs=>azs.toLowerCase().includes(searchText));renderManagerList('azsManagerList',list,openAzsEditor,item=>`<div class="rm-info"><div class="azs-title">${item}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`,'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')}
let editingAzsOldName=null;
function openAzsEditor(azsName=null){vibrate();const sheet=$('azsEditorSheet'),nameInput=$('editAzsName'),delBtn=$('btnDeleteAzs'),title=$('azsEditorTitle');if(azsName){editingAzsOldName=azsName;title.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ê–ó–°';nameInput.value=azsName;delBtn.style.display='flex'}else{editingAzsOldName=null;title.textContent='–ù–æ–≤–∞—è –ê–ó–°';nameInput.value='';delBtn.style.display='none'}sheet.classList.add('active')}
function closeAzsEditor(e){if(!e||e.target.classList.contains('bs-overlay')){$('azsEditorSheet').classList.remove('active');document.activeElement.blur()}}
function saveAzsFromEditor(){const newName=$('editAzsName').value.trim();if(!newName)return showCustomAlert('–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ê–ó–°');let list=parseList($('settingAzs').value);if(editingAzsOldName&&editingAzsOldName!==newName){const idx=list.indexOf(editingAzsOldName);if(idx!==-1)list.splice(idx,1)}if(list.map(x=>x.toLowerCase()).includes(newName.toLowerCase()))return showCustomAlert('–û—à–∏–±–∫–∞','–¢–∞–∫–∞—è –ê–ó–° —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ');list.push(newName);list.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));$('settingAzs').value=list.join(', ');renderAzsManager();checkSettingsDirty();$('azsEditorSheet').classList.remove('active')}
function deleteAzsFromEditor(){if(!editingAzsOldName)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å –ê–ó–° "${editingAzsOldName}"?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let list=parseList($('settingAzs').value);const idx=list.indexOf(editingAzsOldName);if(idx!==-1){list.splice(idx,1);$('settingAzs').value=list.join(', ');renderAzsManager();checkSettingsDirty()}$('azsEditorSheet').classList.remove('active')})}
function openRoutesManagerScreen(){vibrate();renderRoutesManager();$('view-routes-manager').classList.add('active')}
function closeRoutesManagerScreen(){$('view-routes-manager').classList.remove('active');updateBadgesFromInputs()}
function renderRoutesManager(){renderManagerList('routesManagerList',parseList($('settingRoutes').value),openRouteEditor,route=>{const hint=tempHints[route]||state.routeHints[route]||'(–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏)';return`<div class="rm-info"><div class="rm-title">${route}<span class="rm-badge">–ú–ê–†–®–†–£–¢</span></div><div class="rm-hint">${hint}</div></div><div class="rm-icon">‚úé</div>`},'–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤')}
let editingRouteOldName=null;
function openRouteEditor(routeName=null){vibrate();const sheet=$('routeEditorSheet'),nameInput=$('editRouteName'),hintInput=$('editRouteHint'),delBtn=$('btnDeleteRoute'),title=$('routeEditorTitle');currentBindRoute=routeName||"";if(routeName){editingRouteOldName=routeName;title.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç';nameInput.value=routeName;hintInput.value=tempHints[routeName]||state.routeHints[routeName]||'';delBtn.style.display='flex'}else{editingRouteOldName=null;title.textContent='–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç';nameInput.value='';hintInput.value='';delBtn.style.display='none'}sheet.classList.add('active')}
function closeRouteEditor(e){if(!e||e.target.classList.contains('bs-overlay')){$('routeEditorSheet').classList.remove('active');document.activeElement.blur()}}
function saveRouteFromEditor(){const newName=$('editRouteName').value.trim();const newHint=$('editRouteHint').value.trim();if(!newName)return showCustomAlert('–û—à–∏–±–∫–∞','–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞');let currentList=parseList($('settingRoutes').value);if(editingRouteOldName&&editingRouteOldName!==newName){currentList=currentList.filter(r=>r!==editingRouteOldName);delete tempHints[editingRouteOldName];if(tempBindings[editingRouteOldName]){tempBindings[newName]=tempBindings[editingRouteOldName];delete tempBindings[editingRouteOldName]}}if(!editingRouteOldName&&currentList.includes(newName))return showCustomAlert('–û—à–∏–±–∫–∞','–¢–∞–∫–æ–π –º–∞—Ä—à—Ä—É—Ç —É–∂–µ –µ—Å—Ç—å');if(!currentList.includes(newName)){currentList.push(newName);currentList.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}))}tempHints[newName]=newHint;$('settingRoutes').value=currentList.join(', ');renderRoutesManager();checkSettingsDirty();$('routeEditorSheet').classList.remove('active')}
function deleteRouteFromEditor(){if(!editingRouteOldName)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç "${editingRouteOldName}"?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let currentList=parseList($('settingRoutes').value);currentList=currentList.filter(r=>r!==editingRouteOldName);delete tempHints[editingRouteOldName];delete tempBindings[editingRouteOldName];$('settingRoutes').value=currentList.join(', ');renderRoutesManager();checkSettingsDirty();$('routeEditorSheet').classList.remove('active')})}
function openNotesManagerScreen(){vibrate();renderNotesManager();$('view-notes-manager').classList.add('active')}
function closeNotesManagerScreen(){$('view-notes-manager').classList.remove('active');updateBadgesFromInputs()}
function renderNotesManager(){renderManagerList('notesManagerList',parseList($('settingNotes').value),openNoteEditor,note=>`<div class="rm-info"><div class="azs-title">${note}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`)}
let editingNoteOldName=null;
function openNoteEditor(noteName=null){vibrate();const sheet=$('noteEditorSheet'),nameInput=$('editNoteName'),delBtn=$('btnDeleteNote'),title=$('noteEditorTitle');if(noteName){editingNoteOldName=noteName;title.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';nameInput.value=noteName;delBtn.style.display='flex'}else{editingNoteOldName=null;title.textContent='–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞';nameInput.value='';delBtn.style.display='none'}sheet.classList.add('active')}
function closeNoteEditor(e){if(!e||e.target.classList.contains('bs-overlay')){$('noteEditorSheet').classList.remove('active');document.activeElement.blur()}}
function saveNoteFromEditor(){const newName=$('editNoteName').value.trim();if(!newName)return showCustomAlert('–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏');let list=parseList($('settingNotes').value);if(editingNoteOldName&&editingNoteOldName!==newName){const idx=list.indexOf(editingNoteOldName);if(idx!==-1)list.splice(idx,1)}if(list.map(x=>x.toLowerCase()).includes(newName.toLowerCase()))return showCustomAlert('–û—à–∏–±–∫–∞','–¢–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞ —É–∂–µ –µ—Å—Ç—å');list.push(newName);list.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));$('settingNotes').value=list.join(', ');renderNotesManager();checkSettingsDirty();$('noteEditorSheet').classList.remove('active')}
function deleteNoteFromEditor(){if(!editingNoteOldName)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É "${editingNoteOldName}"?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let list=parseList($('settingNotes').value);const idx=list.indexOf(editingNoteOldName);if(idx!==-1){list.splice(idx,1);$('settingNotes').value=list.join(', ');renderNotesManager();checkSettingsDirty()}$('noteEditorSheet').classList.remove('active')})}
let editingContactType='operator',editingContactId=null;
function openContactsManagerScreen(){vibrate();if(!tempContacts.operator)tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));renderContactsManager();$('view-contacts-manager').classList.add('active')}
function closeContactsManagerScreen(){$('view-contacts-manager').classList.remove('active');updateBadgesFromInputs()}
function renderContactsManager(){const r=(type,cid)=>renderManagerList(cid,tempContacts[type],c=>openContactEditor(c,type),c=>`<div class="rm-info"><div class="azs-title" style="font-weight:700;">${c.name}</div><div style="font-size:12px; color:var(--text-sec); font-family:monospace; margin-top:2px;">${c.phone}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`);r('operator','contactsOperatorList');r('expeditor','contactsExpeditorList')}
function openContactEditor(contact=null,type='operator'){vibrate();editingContactType=type;const sheet=$('contactEditorSheet'),nameInput=$('contactNameInput'),phoneInput=$('contactPhoneInput'),delBtn=$('btnDeleteContact'),title=$('contactEditorTitle');const typeLabel=editingContactType==='operator'?'–û–ø–µ—Ä–∞—Ç–æ—Ä':'–≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä';if(contact){editingContactId=contact.id;title.textContent=`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (${typeLabel})`;nameInput.value=contact.name;phoneInput.value=contact.phone;delBtn.style.display='flex'}else{editingContactId=null;title.textContent=`–ù–æ–≤—ã–π ${typeLabel}`;nameInput.value='';phoneInput.value='';delBtn.style.display='none'}sheet.classList.add('active')}
function closeContactEditor(e){if(!e||e.target.classList.contains('bs-overlay')){$('contactEditorSheet').classList.remove('active');document.activeElement.blur()}}
function saveContactFromEditor(){const name=$('contactNameInput').value.trim();const phone=$('contactPhoneInput').value.trim();if(!name||!phone)return showCustomAlert('–û—à–∏–±–∫–∞','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è');if(!tempContacts[editingContactType])tempContacts[editingContactType]=[];if(editingContactId){const idx=tempContacts[editingContactType].findIndex(c=>c.id===editingContactId);if(idx!==-1)tempContacts[editingContactType][idx]={id:editingContactId,name,phone}}else{tempContacts[editingContactType].push({id:Date.now(),name,phone})}renderContactsManager();checkSettingsDirty();$('contactEditorSheet').classList.remove('active')}
function deleteContactFromEditor(){if(!editingContactId)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ','–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç? (–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫)','–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{if(tempContacts[editingContactType])tempContacts[editingContactType]=tempContacts[editingContactType].filter(c=>c.id!==editingContactId);renderContactsManager();checkSettingsDirty();$('contactEditorSheet').classList.remove('active')})}
function openRulesManagerScreen(){vibrate();renderRulesTransitList();$('view-rules-manager').classList.add('active')}
function closeRulesManagerScreen(){$('view-rules-manager').classList.remove('active');updateBadgesFromInputs()}
function renderRulesTransitList(){const wrapper=$('rulesTransitWrapper');wrapper.innerHTML='';const currentList=parseList($('settingTransitList').value);const currentLower=currentList.map(s=>s.toLowerCase());getLiveAzsList().forEach(azs=>{const azsLow=azs.toLowerCase();const btn=document.createElement('div');btn.className='chip';btn.style.padding="8px 14px";btn.textContent=azs;btn.dataset.val=azsLow;if(currentLower.includes(azsLow))btn.classList.add('active');btn.onclick=()=>{vibrate(10);let list=parseList($('settingTransitList').value);const idx=list.findIndex(x=>x.toLowerCase()===azsLow);if(idx>=0){list.splice(idx,1);btn.classList.remove('active')}else{list.push(azs);btn.classList.add('active')}$('settingTransitList').value=list.join(', ');checkSettingsDirty()};wrapper.appendChild(btn)})}
function openBindingsManagerScreen(){vibrate();renderBindingsManager();$('view-bindings-manager').classList.add('active')}
function closeBindingsManagerScreen(){$('view-bindings-manager').classList.remove('active');updateBadgesFromInputs()}
function renderBindingsManager(){renderManagerList('bindingsManagerList',parseList($('settingRoutes').value),route=>{currentBindRoute=route;openBindAzsSheet()},route=>{const bindStr=tempBindings[route]||"";const boundCount=parseList(bindStr).length;const countBadge=boundCount>0?`<span class="rm-badge" style="margin-left:8px; background:rgba(16, 185, 129, 0.15); color:#10b981;">${boundCount} –ê–ó–°</span>`:`<span class="rm-badge" style="margin-left:8px; background:#333; color:#666;">0</span>`;return `<div class="rm-info"><div class="rm-title">${route}${countBadge}</div><div class="rm-hint" style="margin-top:2px; font-size:11px; opacity:0.7;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫</div></div><div class="rm-icon">üîó</div>`},'–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã')}
function openDataManagerScreen(){vibrate();$('view-data-manager').classList.add('active')}
function closeDataManagerScreen(){$('view-data-manager').classList.remove('active')}
init();
</script>
</body>
</html>